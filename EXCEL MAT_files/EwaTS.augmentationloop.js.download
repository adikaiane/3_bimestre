'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[28],{718:function(y,r,a){async function c(rb,rc){const ld=Date.now();try{const Tb=ta.TJd();if(!Tb||0===Tb.length)return I.ULS.sendTraceTag(507635341,0,15,"AugLoopRuntimeProxyService.factory: AugLoopCloudALServiceUrl is null or empty"),b(ld,"AugLoopCloudALServiceUrl is null or empty"),null;const Wc=await Ma.a.resolve(hb.EwaControlService,rb);if(Wc.fa.$b.inWebPart)return I.ULS.sendTraceTag(507527240,0,50,"AugLoopRuntimeProxyService.factory: Disable AugLoop in Web Part"),
null;const Ac=await Ma.a.resolve(hb.OAuthManagerService,rb),nd=await Ma.a.resolve(hb.OAuthManagerWrapperService,rb),qd=rc?await Ma.a.resolve(hb.AugLoopRuntimeTransientService,rb):await Ma.a.resolve(hb.AugLoopRuntimeService,rb);if(!(Wc&&qd&&Ac&&nd))return I.ULS.sendTraceTag(507610115,0,15,"AugLoopRuntimeProxyService.factory: ewaControl or augloopRuntimeManager is null"),b(ld,"Dependent service is null"),null;const Xd=new ta(Wc,qd,Ac,nd);L.Health.instance.recordKpiUsageForAlertableKpi("AugmentationLoopManagerCreation",
"xlalint",null);return Xd}catch(Tb){throw I.ULS.sendTraceTag(507859204,0,15,`AugLoopRuntimeProxyService factory: exception during init: ${Tb}`),b(ld,"Exception"),Tb;}}function b(rb,rc){L.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation",rc,!1,!0,{extendedProperties:new Map,durationMs:Date.now()-rb})}function f(rb,rc){return Array.from(rb.values()).some(ld=>ld.annotations.some(Tb=>Tb.annotationType===rc))}function k(rb,rc,ld){ld=void 0===ld?[]:ld;let Tb=!0;if(rb===rc)Tb=!0;else if("object"!==
typeof rb||"object"!==typeof rc||null==rb||null==rc)Tb=!1;else{const Wc=Object.keys(rb),Ac=Object.keys(rc).filter(nd=>!ld.includes(nd));if(Wc.length<Ac.length)Tb=!1;else for(const nd of Ac)Wc.includes(nd)&&k(rb[nd],rc[nd])||(Tb=!1)}Tb||(console.log("deepEqual: actual: ",rb),console.log("deepEqual: expected: ",rc));return Tb}function x(rb,rc){if("object"!==typeof rc||"object"!==typeof rb||null==rc||null==rb){if(rc!==rb)return{$1b:[{propertyName:"value",AAg:rc,zAg:rb}]}}else if(rc!==rb){var ld=Object.keys(rc),
Tb=new Dd;for(const Wc of ld)void 0!==rc[Wc]&&!Object.hasOwnProperty.call(rb,Wc)||void 0===rc[Wc]||(ld=x(rc[Wc],rb[Wc]),void 0!==ld&&Tb.$1b.push(...ld.$1b.map(Ac=>({propertyName:`${Wc}.${Ac.propertyName}`,AAg:Ac.AAg,zAg:Ac.zAg}))));return Tb}}function d(rb){return void 0===rb?"undefined":`${null===rb||void 0===rb?void 0:rb.Xluid}/${null===rb||void 0===rb?void 0:rb.Xrevid}@${null===rb||void 0===rb?void 0:rb.DocId}`}function h(rb,rc,ld){rb=rb.filter(Tb=>ld.annotationTypes.some(Wc=>Wc===Tb.annotationType));
rc=rc.filter(Tb=>ld.annotationTypes.some(Wc=>Wc===Tb.annotationType));return ld.Aqc===se.NonIdPropertiesByHashCalculation?t(rb,rc):l(rb,rc)}function n(rb,rc){const ld=new Set,Tb=new Map;rc.forEach(Ac=>{const nd=Tb.get(Ac.annotationType)||[];nd.push(Ac);ld.add(Ac.annotationType);Tb.set(Ac.annotationType,nd)});const Wc=new Map;rb.forEach(Ac=>{const nd=Wc.get(Ac.annotationType)||[];nd.push(Ac);Wc.set(Ac.annotationType,nd)});return{fyh:Wc,Fyi:Tb,UIh:ld}}function m(rb,rc,ld,Tb){0!==rb.length&&rb.length===
rc.length&&rb.forEach(Wc=>{let Ac=Number.MAX_VALUE,nd,qd;rc.forEach(Xd=>{const Hd=x(Xd,Wc);Hd.$1b.length<Ac&&(Ac=Hd.$1b.length,nd=Xd,qd=Hd,qd.annotationType=ld)});if(nd){qd.annotationType=ld;Tb.push(qd);const Xd=`AugmentationLoopSanityEndToEndTest: mismatched properties for annotation: ${JSON.stringify(qd)}`;console.log(Xd)}})}function u(rb,rc,ld){let Tb=0;const Wc=[],Ac=[],nd=[];ld=ld.get(rb)||[];const qd=rc.get(rb)||[],Xd=[],Hd=[];ld.forEach(Zc=>{const Jc=Zc.annotation;let gc=!1;qd.forEach(dd=>
{!gc&&k(dd.annotation,Jc)&&(gc=!0,dd=qd.indexOf(dd),-1<dd&&qd.splice(dd,1))});gc?Tb++:(Xd.push(Jc),Ac.push({annotationType:Zc.annotationType,parentPath:Zc.parentPath,annotationId:Zc.annotation.id,annotation:Jc}))});qd.forEach(Zc=>{Hd.push(Zc.annotation);nd.push({annotationType:Zc.annotationType,parentPath:Zc.parentPath,annotationId:Zc.annotation.id,annotation:Zc.annotation})});m(Xd,Hd,rb,Wc);return{BRj:Tb,Awc:Ac,wkc:nd,Q6e:Wc}}function l(rb,rc){const {fyh:ld,Fyi:Tb,UIh:Wc}=n(rb,rc);rb=0;rc=[];const Ac=
[],nd=[];for(const qd of Wc){const {BRj:Xd,Awc:Hd,wkc:Zc,Q6e:Jc}=u(qd,ld,Tb);rb+=Xd;rc.push(...Hd);Ac.push(...Zc);nd.push(...Jc)}return{ceg:rb,Awc:rc,wkc:Ac,Q6e:nd}}function t(rb,rc){rb=new Map(rb.map(qd=>[w(qd.annotationType,qd.annotation),{annotationType:qd.annotationType,parentPath:qd.parentPath,annotation:qd.annotation}]));var ld=new Set(rb.keys());const Tb=new Map(Array.from(rc,qd=>[w(qd.annotationType,qd.annotation),{annotationType:qd.annotationType,parentPath:qd.parentPath,annotation:qd.annotation}]));
var Wc=new Set(Tb.keys());rc=0;const Ac=[];for(var nd of Wc)rb.has(nd)?(ld.delete(nd),rc++):(Wc=Tb.get(nd),Ac.push({annotationType:Wc.annotationType,parentPath:Wc.parentPath,annotationId:Wc.annotation.id,annotation:Wc.annotation}));nd=[];for(const qd of ld)ld=rb.get(qd),nd.push({annotationType:ld.annotationType,parentPath:ld.parentPath,annotationId:ld.annotation.id,annotation:ld.annotation});return{ceg:rc,Awc:Ac,wkc:nd}}function e(rb,rc){rb.forEach(ld=>{const Tb=rc.find(nd=>nd.annotationType===ld.annotationType&&
JSON.stringify(nd.parentPath)===JSON.stringify(ld.parentPath)).annotation;var Wc=Object.keys(Tb);const Ac=Wc.map(nd=>Tb[nd].length);Wc=Wc.map((nd,qd)=>`${nd}: ${Ac[qd]}`);Wc=`AugmentationLoopSanityEndToEndTest: missing annotation's properties: ${JSON.stringify(Wc)}`;console.log(Wc);I.ULS.sendTraceTag(507320158,0,10,Wc)})}function w(rb,rc){switch(rb){case "AugLoop_Tablelint_TableLintColumnAnnotation":return JSON.stringify({annotationType:"AugLoop_Tablelint_TableLintColumnAnnotation",columnTitle:rc.columnTitle,
columnName:rc.columnName,suggestions:JSON.stringify(rc.suggestions),investigationTelemetry:JSON.stringify(rc.investigationTelemetry),worksheetId:rc.worksheetId,tableName:rc.tableName,tableRange:JSON.stringify(rc.tableRange),tableIdentifier:rc.tableIdentifier,columnIdentifier:rc.columnIdentifier});case "AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation":return JSON.stringify({annotationType:"AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation",isSeedingRequired:rc.isSeedingRequired});case "AugLoop_ExcelCleanData_ExtraSpacesTableAnnotation":return JSON.stringify({annotationType:"AugLoop_ExcelCleanData_ExtraSpacesTableAnnotation",
worksheetId:rc.worksheetId,tableIdentifier:rc.tableIdentifier,tableRange:JSON.stringify(rc.tableRange),boundaryConfidence:rc.boundaryConfidence,tableName:rc.tableName,rangesWithLeading:JSON.stringify(rc.rangesWithLeading),rangesWithTrailing:JSON.stringify(rc.rangesWithTrailing),rangesWithInBetween:JSON.stringify(rc.rangesWithInBetween)});default:return`annotationType: ${rb}`}}function z(rb){rb=Ed.f(rb).Ob(new de.Range(1,1,1,1,!1,!1));return void 0===rb||null===rb||void 0===rb.originalText||""===rb.originalText?
Fe:JSON.parse(rb.originalText)}function E(rb){var rc=Ed.f(rb);const ld=new Pc;for(rb=2;;rb++){const Wc=rc.Ob(new de.Range(1,rb,1,rb,!1,!1));if((null===Wc||void 0===Wc?0:Wc.originalText)&&""!==(null===Wc||void 0===Wc?void 0:Wc.originalText))try{var Tb=JSON.parse(Wc.originalText);if(!Array.isArray(Tb))throw Error("Expected the originalText to be a JSON array");ld.kej(Tb)}catch(Ac){Tb="";for(rc=rb;0<rc;)rb=(rc-1)%26,Tb=String.fromCharCode(65+rb)+Tb,rc=Math.floor((rc-rb)/26);rb=`Error parsing annotation items at cell ${Tb}${1}: ${Ac}`;
console.error(rb);throw Error(rb);}else break}return ld}function M(rb,rc,ld){var Tb;try{console.log("AugmentationLoopSanityEndToEndTest: starting to read the expected annotations");I.ULS.sendTraceTag(507320157,0,50,"AugmentationLoopSanityEndToEndTest: starting to read the expected annotations");const Wc=E(rb),Ac=z(rb),nd=Ac.annotationTypes;console.log(`AugmentationLoopSanityEndToEndTest: waiting ${Ac.bxe} milliseconds for annotations to be received from websocket`);oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8838245_AugloopSanityEndToEndCompareLogs")&&
I.ULS.sendTraceTag(507320156,0,50,`AugmentationLoopSanityEndToEndTest: waiting ${Ac.bxe} milliseconds for annotations to be received from websocket`);const qd=Wc.dAf(nd).map(Xd=>({annotationType:Xd.annotationType,parentPath:Xd.aT.parentPath,annotation:Xd.aT.annotation}));qd.forEach(Xd=>{ld.Iea("ALManagerInternalAnnotations",{annotationType:Xd.annotationType,ls:!0})});setTimeout(()=>{console.log("AugmentationLoopSanityEndToEndTest: starting to compare the annotation pools");oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8838245_AugloopSanityEndToEndCompareLogs")&&
I.ULS.sendTraceTag(507320155,0,50,"AugmentationLoopSanityEndToEndTest: starting to compare the annotation pools");const Xd=rc.dAf(nd).map(dd=>({annotationType:dd.annotationType,parentPath:dd.aT.parentPath,annotation:dd.aT.annotation})),{ceg:Hd,Awc:Zc,wkc:Jc}=h(Xd,qd,Ac);console.log("AugmentationLoopSanityEndToEndTest: logging the comparison results:");oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8838245_AugloopSanityEndToEndCompareLogs")&&I.ULS.sendTraceTag(507320154,0,50,"AugmentationLoopSanityEndToEndTest: logging the comparison results:");
var gc=`${Hd} annotations matched`;console.log(gc);oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8838245_AugloopSanityEndToEndCompareLogs")&&I.ULS.sendTraceTag(507320153,0,50,gc);if(0===Zc.length&&0===Jc.length)console.log("AugmentationLoopSanityEndToEndTest: success"),oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8838245_AugloopSanityEndToEndCompareLogs")&&I.ULS.sendTraceTag(507320152,0,50,"AugmentationLoopSanityEndToEndTest: success"),alert(`AugmentationLoopSanityEndToEndTest: success. ${gc}`);
else{let dd=gc="";0<Zc.length&&(gc=` ${Zc.length} annotations expected but missing.`,console.log(`AugmentationLoopSanityEndToEndTest:${gc} : ${JSON.stringify(Zc)}`),oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8838245_AugloopSanityEndToEndCompareLogs")&&(I.ULS.sendTraceTag(507320151,0,50,`AugmentationLoopSanityEndToEndTest:${gc}`),e(Zc,qd)));0<Jc.length&&(dd=` ${Jc.length} annotations unexpected but present.`,console.log(`AugmentationLoopSanityEndToEndTest:${dd} : ${JSON.stringify(Jc)}`),oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8838245_AugloopSanityEndToEndCompareLogs")&&
(I.ULS.sendTraceTag(507320150,0,50,`AugmentationLoopSanityEndToEndTest:${dd}`),e(Jc,Xd)));alert(`AugmentationLoopSanityEndToEndTest: failed.${gc}${dd}`)}},null!==(Tb=Ac.bxe)&&void 0!==Tb?Tb:1E4)}catch(Wc){console.log("AugmentationLoopSanityEndToEndTest: failed "+Wc),alert("AugmentationLoopSanityEndToEndTest: failed "+Wc)}}a.r(r);var G={};a.r(G);a.d(G,"AugmentationLoopServerStatus",function(){return Z});a.d(G,"AugLoopRuntimeProxy",function(){return ta});var A={};a.r(A);a.d(A,"AugmentationLoopManager",
function(){return Kb});var N=a(0),K=a(2),I=a(15),L=a(103),J=a(6),B=a(545),Y=a(298),U=a(178),O=a(32),C=a(1309);class X{sendMessage(rb){I.ULS.sendTraceTag(508965922,306,100,"AL send SDX message");C.a.ZFk(rb)}registerMessageReceivedCallback(rb){I.ULS.sendTraceTag(508965921,306,50,"AL handle SDX message");C.a.Zok(rb)}}Object(N.a)(X,"SdxMessageBridge",null,[196]);var S=a(608),ea=a(367);class Oa extends S.a{constructor(){super();this.errorCode=this.isExpected=this.isRetryableError=this.errorType=null;this.H_=
Object.assign(new ea.a,{T_:Oa.getTypeName(),B_:Oa.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelSessionCloseReason"}static getBaseTypes(){return[]}}Object(N.a)(Oa,"ExcelSessionCloseReason",S.a,[]);class Ha extends S.a{constructor(){super();this.reasonDescription=null;this.H_=Object.assign(new ea.a,{T_:Ha.getTypeName(),B_:Ha.getBaseTypes()})}static getTypeName(){return"AugLoop_Session_Protocol_SessionCloseReason"}static getBaseTypes(){return[]}}Object(N.a)(Ha,"SessionCloseReason",
S.a,[]);class Za{constructor(){this.handler=null}}Object(N.a)(Za,"SetAnnotationResultCallbackParameters",null,[]);var fa=a(154),la=a(1661),ba=a(33),aa=a(145),oa=a(1);class Na{constructor(){this.syncDeltaTimeout=this.disableSyncDeltaSending=this.isDeltaGeneratorEnabled=this.powerpoint=this.downloadPolymerBaseUrl=this.inferenceServiceVersion=this.downloadBaseUrl=this.sessionCreationOptions=this.disabledServiceGroups=this.privateMode=this.flights=this.excelServer=this.initSession=this.sessionId=this.releaseFork=
this.releaseCustomAudience=this.releaseChannel=this.releaseAudienceGroup=this.uiLanguage=this.appVersion=this.appName=this.serviceUrl=null}}Object(N.a)(Na,"InitializeParameters",null,[]);class Ia{constructor(){this.documentId=this.userContext=this.enableRemoteExecutionNotification=this.networkMode=this.egress=this.localRegisteredWorkflows=this.enableComplexLocalWorkflows=this.serviceUrl=this.onClaimsChallengeCallback=this.onServerAuthenticationStateChangeCallback=this.onSessionClose=this.onSessionReconnect=
this.onSessionDisconnect=this.onSessionConnect=this.flights=this.extensionConfigs=this.docSessionId=null}}Object(N.a)(Ia,"SessionCreationOptions",null,[]);class Sa{constructor(){this.callback=null}}Object(N.a)(Sa,"SetConnectCallbackParameters",null,[]);class Pa{constructor(){this.featureEnabledCallback=null}}Object(N.a)(Pa,"SetIsFeatureEnabledCallbackParameters",null,[]);class za{constructor(){this.changeGateEnabledCallback=null}}Object(N.a)(za,"SetIsChangeGateEnabledCallbackParameters",null,[]);
class wa{constructor(){this.requestAuthTokenCallback=null}}Object(N.a)(wa,"SetRequestAuthTokenCallbackParameters",null,[]);class db{constructor(){this.sendOTelEvent=null}}Object(N.a)(db,"SetSendOTelEventCallbackParameters",null,[]);class Ba{constructor(){this.handler=null}}Object(N.a)(Ba,"SetSessionInitOverrideCallbackParameters",null,[]);class Ka{constructor(){this.ulsLogger=null}}Object(N.a)(Ka,"SetULSLoggerParameters",null,[]);var da=a(1153);class sa extends S.a{constructor(){super();this.isLargeWorkbookSession=
this.workbookLocationUrl=this.activeWorksheetId=this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.collabUserListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.workbookMetadataVersion=this.ecsOperationUrl=this.restUrl=this.ecsId=this.cluster=null;this.H_=Object.assign(new ea.a,{T_:sa.getTypeName(),B_:sa.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelServerSessionExtensionConfig"}static getBaseTypes(){return[]}}
Object(N.a)(sa,"ExcelServerSessionExtensionConfig",S.a,[]);var mb=a(74),Ma=a(65),hb=a(5),$a=a(941);class Va{constructor(){this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.userListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.metadataVersion=this.ecsOperationUrl=this.ecsRestUrl=this.ecsSessionId=this.wacCluster=null}}Object(N.a)(Va,"ExcelServerParameters",null,[]);class xa{constructor(){this.excelServerParameters=null}}Object(N.a)(xa,
"ForceReconnectParameters",null,[]);var ia=a(1436),Z;(function(rb){rb[rb.FullyActive=0]="FullyActive";rb[rb.ClosedAndWaitingOnlyForNonModelRequiredActivation=1]="ClosedAndWaitingOnlyForNonModelRequiredActivation";rb[rb.ActiveForNonModelRequired=2]="ActiveForNonModelRequired";rb[rb.Closed=3]="Closed"})(Z||(Z={}));Object(N.b)("AugmentationLoopServerStatus",Z);Object(Ma.b)(hb.AugLoopRuntimeProxyService,{we:"singleton"})(async rb=>c(rb,!1));Object(Ma.b)(hb.AugLoopRuntimeProxyTransientService,{we:"transient"})(async rb=>
c(rb,!0));class ta{get name(){return this._name}get S9(){return this.Oth}constructor(rb,rc,ld,Tb,Wc){Wc=void 0===Wc?ba.a.zb:Wc;this.$=rb;this.BV=rc;this.XY=ld;this.xla=Tb;this.vj=Wc;this.zeg=3;this.EDg=3E5;this.FUg=J.AFrameworkApplication.ea.getBooleanFeatureGate("Microsoft.Office.Excel.Augloop.GetAugLoopOrFallbackToken",!0);this.tH=Z.FullyActive;this.MSc=0;this.X0c=null;this.pBb=!1;this.WTa=null;this.j_a=()=>!1;this.rWd=null;this.isFeatureEnabled=Ac=>{const nd=J.AFrameworkApplication.ea.ka("AugLoop"+
Ac),qd=oa.EwaSettings.getBooleanFeatureGate(Ac,!1),Xd=oa.EwaSettings.getBooleanFeatureGate("AugLoop"+Ac,!1);var Hd=oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel."+Ac,!1);Hd=qd||Xd||Hd;const Zc=nd||Hd;this.rWd.has(Ac)||(this.rWd.add(Ac),I.ULS.shipAssertTag(537170337,0,!(nd&&!Hd),`AugLoopRuntimeProxy.isFeatureEnabled: legacy app setting return true for feature ${Ac}, but feature gate return false. This is problem because app setting is depricated and about to be removed`),Zc&&I.ULS.sendTraceTag(537170336,
0,50,`AugLoopRuntimeProxy.isFeatureEnabled: feature ${Ac} is enabled. legacyAppSettingResult: ${nd}, featureGateWithoutPrefix: ${qd}, featureGateWithPrefix: ${Xd}`));return Zc};this.aJj=()=>{var Ac,nd;const qd=new Map;var Xd=oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8633499_ExcelAugLoopPropagateAugLoopNamespaceClientFlights");if(Xd){var Hd=oa.EwaSettings.Hzc("AugLoop");for(const dd of Hd){const [Bb,pc]=dd;qd.set(Bb,String(pc))}}Hd=oa.EwaSettings.Hzc("AugmentationLoopTableLint");for(var Zc of Hd){const [dd,
Bb]=Zc;qd.set(dd,String(Bb))}Zc=oa.EwaSettings.Hzc("AugmentationLoopInfra");for(var Jc of Zc){const [dd,Bb]=Jc;qd.set(dd,String(Bb))}Jc=oa.EwaSettings.Hzc("CalculatedColumns");for(var gc of Jc){const [dd,Bb]=gc;qd.set(dd,String(Bb))}oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UseChainedCustomResponseSkill",!1)&&qd.set("Microsoft.Office.Excel.UseChainedCustomResponseSkill","true");(gc=oa.EwaSettings.getStringFeatureGate("Microsoft.Office.Excel.FluxCopilotFeatures",""))&&qd.set("Microsoft.Office.Excel.FluxCopilotFeatures",
gc);(gc=oa.EwaSettings.getStringFeatureGate("Microsoft.Office.Excel.FluxOptionSets",""))&&qd.set("Microsoft.Office.SharedOnline.Augloop.Copilot.OptionSets",gc);oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FA000000124.CalculatedColumnsHybridWorkflow",!1)&&(qd.set("Microsoft.Office.Excel.CalculatedColumnsHybridWorkflow","true"),qd.set("Microsoft.Office.Excel.AugmentationLoopTableLintRecognitionPullWorkflows","true"));oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.CopilotContextIQEnabled",
!1)&&(qd.set("mc-editor-oa",void 0),qd.set("Microsoft.Office.Excel.ContextIQAtMentionEntryPointIsEnabled","true"),qd.set("Microsoft.Office.Excel.ContextIQTextPredictionsIsEnabled","true"));oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.CalculatedColumnsTLRMultiTableSupport",!1)&&(qd.set("Microsoft.Office.Excel.TLRMultiTableSupport","true"),qd.set("Microsoft.Office.Excel.CalculatedColumnsTLRMultiTableSupport","true"));oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.useBetaOptionSets",
!1)&&qd.set("Microsoft.Office.Excel.useBetaOptionSets","true");oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.useBeta2OptionSets",!1)&&qd.set("Microsoft.Office.Excel.useBeta2OptionSets","true");oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FA000000124.OfficeJsCommanding",!1)&&qd.set("Microsoft.Office.Excel.OfficeJsCommanding","true");(gc=oa.EwaSettings.getStringFeatureGate("Microsoft.Office.Excel.FluxSkillOverride",""))&&qd.set("Microsoft.Office.Excel.FluxSkillOverride",
gc);oa.EwaSettings.getBooleanFeatureGate($a.a.wia,!1)&&qd.set($a.a.wia,"true");oa.EwaSettings.Ra(387)&&qd.set("EnterpriseDataTypeMipSupport",void 0);oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.DataCleansingTaskPane",!1)&&qd.set("LoadAdditionalDataToModel",void 0);oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TelemetryWorkflowIncludeTextHints",!1)&&qd.set("TelemetryWorkflowIncludeTextHints",void 0);oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceLogging",
!1)&&qd.set("TableIntelligenceLogging",void 0);oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UseTableSenseML",!1)&&qd.set("UseTableSenseML",void 0);oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableSenseOnAML",!1)&&qd.set("TableSenseOnAML",void 0);oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligence.ExcelTableSummaryWorkflow",!1)&&qd.set("Microsoft.Office.Excel.TableIntelligence.ExcelTableSummaryWorkflow","true");(null===(nd=null===(Ac=this.$)||
void 0===Ac?void 0:Ac.qa)||void 0===nd?0:nd.count)&&100<this.$.qa.count&&(qd.set("TableIntelligenceSheetCountThreshold",void 0),I.ULS.sendTraceTag(521151777,306,50,`TableIntelligence max sheet count exceeded. SheetCount: ${this.$.qa.count}`));Ac=oa.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.ProactiveSuggestionIsPivotableThreshold",-1);-1!==Ac&&qd.set("Microsoft.Office.Excel.ProactiveSuggestionIsPivotableThreshold",Ac.toString());!Xd&&oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugLoop.FluxMultiLanguageSupport",
!1)&&qd.set("Microsoft.Office.Excel.AugLoop.FluxMultiLanguageSupport","true");Xd=oa.EwaSettings.cPi();for(const dd of Xd)qd.set(dd,"false");return qd};this.initSessionCallback=()=>{var Ac,nd;if(null===(nd=null===(Ac=this.$)||void 0===Ac?void 0:Ac.fa)||void 0===nd?0:nd.sessionId)return I.ULS.sendTraceTag(527708568,0,50,`AugLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is valid (length = ${this.$.fa.sessionId.length}), return resolved promise`),Promise.resolve();I.ULS.sendTraceTag(527708567,
0,50,"AugLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is not valid, return promise that will be resolved when session id will be valid again.");return new Promise(qd=>{var Xd,Hd;const Zc=()=>{var Jc,gc;(null===(gc=null===(Jc=this.$)||void 0===Jc?void 0:Jc.fa)||void 0===gc?0:gc.sessionId)?(I.ULS.sendTraceTag(527708566,0,50,`AugLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called with valid session id (length = ${this.$.fa.sessionId.length}), resolve the promise and unregister the callback.`),
this.$.fa.Qk(Zc),qd()):I.ULS.sendTraceTag(527708565,0,50,"AugLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called, but the session id is not valid yet, keep waiting.")};null===(Hd=null===(Xd=this.$)||void 0===Xd?void 0:Xd.fa)||void 0===Hd?void 0:Hd.Vk(Zc)})};this.CHk=Ac=>{var nd;Ac.extensionConfigs=[Object(K.a)(new sa,{cluster:this.$.ta.MachineCluster,ecsId:this.GPi(),restUrl:this.$.ta.RestActionUrl,ecsOperationUrl:"",workbookMetadataVersion:0,serverEventVersion:0,permissionFlags:0,
configurations:0,collabUserListVersion:0,collabStateId:0,accessToken:this.$.ta.AccessToken,accessTokenTTL:this.$.ta.AccessTokenValidTo.toString(),activeWorksheetId:null!==(nd=Object(mb.d)(this.$.la))&&void 0!==nd?nd:void 0,workbookLocationUrl:this.$.ta.DocumentHostInfo.HostEmbeddedViewUrl,isLargeWorkbookSession:this.j_a(this.tH)})];Ac.clientMetadata.documentId=this.$.ta.DocumentHostInfo.ServerDocId;I.ULS.sendTraceTag(509682397,0,50,`AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: access token TTL ${this.$.ta.AccessTokenValidTo.toString()}, activeWorksheetId ${Object(mb.d)(this.$.la)}`);
return Ac}}getAugLoopRuntimeManager(){return this.BV}get J2(){return this.pBb}forceReconnectSession(rb){oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8994066_UpdateNewUserAccessTokenV2")&&!this.J2?I.ULS.sendTraceTag(507787421,0,50,`AugmentationLoopRuntimeProxy.forceReconnectSession: web socket is inactive, returning with no-op. Caller: ${rb}`):(I.ULS.sendTraceTag(507787420,0,50,`AugmentationLoopRuntimeProxy.forceReconnectSession: calling force reconnect. Caller: ${rb}`),this.BV.forceReconnectSession(Object(K.a)(new xa,
{excelServerParameters:Object(K.a)(new Va,{wacCluster:this.$.ta.MachineCluster,ecsSessionId:this.$.fa.sessionId,ecsRestUrl:this.$.ta.RestActionUrl,ecsOperationUrl:"",metadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,userListVersion:0,collabStateId:0,accessToken:this.$.ta.AccessToken,accessTokenTTL:this.$.ta.AccessTokenValidTo.toString()})})).catch(rc=>{I.ULS.sendTraceTag(507798540,0,50,`AugmentationLoopRuntimeProxy.forceReconnectSession: forceReconnectSession promise rejected. Caller: ${rb}, Error ${rc}`)}))}OWf(rb,
rc,ld,Tb){this._name=rb;this.Oth=Tb;this.rWd=new Set;I.ULS.sendTraceTag(522803219,0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: setIsFeatureEnabledCallback");this.BV.setIsFeatureEnabledCallback(Object(K.a)(new Pa,{featureEnabledCallback:this.isFeatureEnabled}));this.BV.setIsChangeGateEnabledCallback(Object.assign(new za,{changeGateEnabledCallback:oa.EwaSettings.isChangeGateEnabled}));(this.FUg?this.XY:this.xla)?(Tb=this.Iyc(this.XY,this.xla),Tb=this.Iyc(this.XY,this.xla,J.AFrameworkApplication.ea.Qa("AugloopACLPUserDataSignature")),
I.ULS.sendTraceTag(522803218,0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: Callback is passed to the augloop runtime which calls the code  when an auth token is required"),this.BV.setRequestAuthTokenCallback(Object(K.a)(new wa,{requestAuthTokenCallback:Tb}))):I.ULS.sendTraceTag(537170335,0,10,"Oauth manager is null");I.ULS.sendTraceTag(522803217,0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setULSLogger");this.BV.setULSLogger(Object(K.a)(new Ka,{ulsLogger:new B.a}));
I.ULS.sendTraceTag(522803216,0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSendOTelEventCallback");this.BV.setSendOTelEventCallback(Object(K.a)(new db,{sendOTelEvent:this.sendOTelEvent}));Tb=this.aJj();I.ULS.sendTraceTag(522803215,0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setInitSessionCallback");this.BV.setInitSessionCallback({initSessionCallback:this.initSessionCallback});I.ULS.sendTraceTag(522803214,0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSessionInitOverrideCallback");
this.BV.setSessionInitOverrideCallback(Object(K.a)(new Ba,{handler:this.CHk}));I.ULS.sendTraceTag(522803213,0,50,"AugLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.initialize - onSessionClose: getOnCloseMessageCallback ");this.E4f()&&this.BV.setConnectCallback(Object(K.a)(new Sa,{callback:(Ac,nd,qd,Xd)=>{this.TOg({isSeedingRequired:Ac,sessionUrl:nd,origin:qd,authToken:Xd},!1)}}));const Wc=ta.TJd();rb=this.$.ta.UserSessionId+"_"+rb;this.BV.initialize(Object(K.a)(new Na,{serviceUrl:Wc,
appName:"Excel",appVersion:J.AFrameworkApplication.ea.Qa("BuildVersion")||"",releaseAudienceGroup:J.AFrameworkApplication.tc?Object(fa.a)(String,J.AFrameworkApplication.tc.AudienceGroup)||"":"",releaseChannel:null,releaseFork:null,sessionId:this.$.ta.UserSessionId,initSession:!0,flights:this.J3h(Tb),uiLanguage:J.AFrameworkApplication.uiCulture,excelServer:null,sessionCreationOptions:Object(K.a)(new Ia,{docSessionId:rb,onSessionConnect:this.QWi(),onSessionDisconnect:this.RWi(),onSessionReconnect:this.SWi(),
onSessionClose:this.PWi()})}));ld&&this.BV.setMessageBridge({bridge:new X});oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8991073_initializeRuntimeProxiesAsynchronously")||(this.BV.setAnnotationResultCallback(Object(K.a)(new Za,{handler:Ac=>rc.n0(Ac,this.name)})),this.WTa=rc.WTa,this.j_a=rc.j_a)}pxd(rb){this.BV.setAnnotationResultCallback(Object(K.a)(new Za,{handler:rc=>rb.n0(rc,this.name)}));this.WTa=rb.WTa;this.j_a=rb.j_a}J3h(rb){return Array.from(rb.entries()).map(rc=>{var [ld,Tb]=rc;return void 0!==
Tb?`${ld}:${Tb}`:ld}).map(rc=>rc+";").join("")}i5k(){return null===this.X0c?void 0:aa.a(this.vj,this.X0c)}UKj(rb){(void 0===rb||rb>this.EDg)&&this.Gyk();(rb=this.MSc>=this.zeg)?I.ULS.sendTraceTag(537170327,0,15,`AugLoopRuntimeProxy.maxReconnectAttemptsReached: Reached the limit of ${this.zeg} attempts for session creation under interval of ${this.EDg} Ms. Stop trying to reconnect. Time of first attempt in this iterval: ${this.X0c}.`):this.MSc++;return rb}PWi(){function rb(rc){if(Y.a.instance.tI(J.AFrameworkApplication.accessTokenTtl))return I.ULS.sendTraceTag(508143571,
0,15,"AugLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: access token has expired"),!1;if(!rc)return I.ULS.shipAssertTag(508143570,0,!1,"AugLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: - closeMessage is null"),!0;rc=rc.reason;if(!rc)return I.ULS.shipAssertTag(508160203,0,!1,"AugLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: - closeMessage.closeReason is null"),!0;switch(S.a.getTypeNameFor(rc)){case Oa.getTypeName():return rc=rc.errorType,I.ULS.shipAssertTag(508143569,0,!(void 0===rc||null===
rc),"AugLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: closeReason.errorType is null"),null==rc||2===rc;case Ha.getTypeName():rc=rc.reasonDescription;if("ClientRequested"===rc)return I.ULS.sendTraceTag(508145861,0,15,"AugmentationLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: SessionCloseReason description is ClientRequested"),!1;I.ULS.shipAssertTag(508160202,0,!1,`AugLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: closeReason.reasonDescription is not recognized. reasonDescription: ${rc}`);return!0;
default:return I.ULS.shipAssertTag(508160201,0,!1,`AugLoopRuntimeProxy.shouldRetryBasedOnCloseMessage: closeReason.getTypeName() is not recognized. closeReason: ${JSON.stringify(rc)}`),!0}}return rc=>{const ld=rb(rc),Tb=this.i5k(),Wc=ld&&!this.UKj(Tb);I.ULS.sendTraceTag(508143568,0,50,`AugLoopRuntimeProxy.getOnCloseMessageCallback: ${JSON.stringify({shouldRetryBasedOnCloseMessage:ld,reconnecting:Wc,reconnectsCounter:this.MSc,millisecondsSinceFirstReconnectInInterval:Tb,closeMessage:rc})}`);this.o7i(rc,
Wc);this.pBb=!1}}o7i(rb,rc){var ld;null===(ld=this.WTa)||void 0===ld?void 0:ld.call(this,this,rc,rb)}QWi(){return(rb,rc)=>{rb=rc.substring(rc.lastIndexOf("/")+1);I.ULS.sendTraceTag(508622662,0,50,`AugLoopRuntimeProxy.getOnConnectMessageCallback: sessionKey ${rb}.`);this.pBb=!0}}RWi(){return rb=>{I.ULS.sendTraceTag(507564314,0,50,`AugmentationLoopRuntimeProxy.getOnDisconnectMessageCallback: previous isWebsocketToAugloopActive=${this.J2}, error ${rb}. setting to false.`);this.pBb=!1}}SWi(){return()=>
{I.ULS.sendTraceTag(507564313,0,50,`AugmentationLoopRuntimeProxy.getOnReconnectMessageCallback: previous isWebsocketToAugloopActive=${this.J2}. setting to true.`);this.pBb=!0}}Gyk(){this.MSc=0;this.X0c=this.vj.Jc}async IGk(rb){rb=new la.a({authToken:rb});const rc=new da.a;rc.message=rb;await this.BV.submitCustomMessage(rc)}async YJi(rb,rc,ld,Tb){const Wc=this.c1f()?Tb.Claims:void 0,{zMh:Ac,yMh:nd,tzi:qd,qzi:Xd}=await Object(ia.c)(rb,rc,ld,this.IGk.bind(this),Wc);rc=(rb=!!Ac&&!nd)?Ac:qd;this.E4f()&&
!rb&&(Tb.ConnectParams?this.TOg(Tb.ConnectParams,!0):I.ULS.sendTraceTag(507326815,0,10,"AugmentationLoopRuntimeProxy.getAugLoopOrFallbackToken: ConnectParams is undefined for SPO Acquire flow"));if(!rc)throw Error(Xd);return rc}E4f(){return J.AFrameworkApplication.ea.getBooleanFeatureGate("Microsoft.Office.Excel.Augloop.SendAuthTokenViaAcquireFlow",!0)}c1f(){return J.AFrameworkApplication.ea.getBooleanFeatureGate("Microsoft.Office.Excel.Augloop.HandleClaimsChallenge",!1)}TOg(rb,rc){J.AFrameworkApplication.ea.getBooleanFeatureGate("Microsoft.Office.Excel.Augloop.SendAcquireTokenOnAuthFailure",
!1)===rc?void Object(ia.d)(rb.isSeedingRequired,rb.sessionUrl,rb.origin,rb.authToken,J.AFrameworkApplication.od):I.ULS.sendTraceTag(507326816,0,50,"AugmentationLoopRuntimeProxy.sendAuthTokenViaAcquireFlow: Skipping sending SPO Acquire token on "+(rc?"auth failure":"connect"))}Iyc(rb,rc,ld){ld=void 0===ld?"":ld;return Tb=>{try{I.ULS.sendTraceTag(527970953,0,50,`AugLoopRuntimeProxy.getAuthTokenDelegate: called with fallbackValue.length: ${ld.length}.`);if(this.c1f()&&Tb.Claims)return Object(ia.a)(rb,
J.AFrameworkApplication.ea,Tb.Claims);if(this.FUg){const Wc=J.AFrameworkApplication.ea.getIntFeatureGate("Microsoft.Office.Excel.Augloop.GetTokenTimeoutMs",9E3);return this.YJi(rb,J.AFrameworkApplication.ea,Wc,Tb)}return rc.ey("AugLoop",J.AFrameworkApplication.ea.Qa("AugLoopOAuthResourceUriV2")).then(Wc=>{if(Wc.IsSuccess)return I.ULS.sendTraceTag(527970952,0,50,"AugLoopRuntimeProxy.getAuthTokenDelegate: successfully fetch token."),Wc.Token;I.ULS.sendTraceTag(537170326,0,15,`AugLoopRuntimeProxy.getAuthTokenDelegate: failed to get token, use fallback value (length: ${ld.length})`);
return ld},()=>{I.ULS.sendTraceTag(537170325,0,15,"AugLoopRuntimeProxy.getAuthTokenDelegate: got rejected promise, use fallback value");return ld})}catch(Wc){return I.ULS.sendTraceTag(537170324,0,10,"Exception thrown when fetching token"),Promise.resolve(ld)}}}sendOTelEvent(rb){U.a.sendOtelEvent({otelEvent:rb})}GPi(){const rb=O.a.Jf(this.$.fa.sessionId);return`cluster=${this.$.ta.MachineCluster}&session=${rb}&usid=${this.$.ta.UserSessionId}`}static TJd(){var rb;return null!==(rb=this.$Ji())&&void 0!==
rb?rb:J.AFrameworkApplication.ea.Qa("AugLoopCloudALServiceUrl")}static $Ji(){var rb,rc=rb||(rb={});rc[rc.Test=1]="Test";rc[rc.Int=2]="Int";rc[rc.DogFood=3]="DogFood";rc[rc.Prod=4]="Prod";rc[rc.LocalHost=5]="LocalHost";Object(N.b)("AugLoopEndpointType",rb);rb={[rb.Test]:"https://augloop-test.officeppe.com",[rb.Int]:"https://augloop-int.officeppe.com",[rb.DogFood]:"https://augloop-dogfood.officeppe.com",[rb.Prod]:"https://augloop.office.com",[rb.LocalHost]:"http://localhost:20080"};rc=J.AFrameworkApplication.ea.getIntFeatureGate("Microsoft.Office.Excel.Augloop.EndpointOverride",
0);return rb[rc]}}Object(N.a)(ta,"AugLoopRuntimeProxy",null,[]);var pa=a(609);class Ga{}Object(N.a)(Ga,"WorkbookCoauthVersion",null,[]);var Ca=a(41),kb=a(61);class eb extends Sys.EventArgs{constructor(rb,rc,ld,Tb,Wc){super();this.annotation=rb;this.r$j=rc;this.parentPath=ld;this.operationType=Tb;this.H4a=Wc}}Object(N.a)(eb,"AnnotationEventArgs",Sys.EventArgs,[]);class Yb{constructor(){this.forceReturnCachedAnnotations=this.stateUpdateHandler=this.handler=this.config=this.annotationType=null}}Object(N.a)(Yb,
"ActivateAnnotationParameters",null,[]);class Gb{constructor(){this.workflow=null}}Object(N.a)(Gb,"RegisterLocalWorkflowParameters",null,[]);class Mb{constructor(){this.cv=this.operation=null}}Object(N.a)(Mb,"SubmitOperationParameters",null,[]);var Rb=a(614),$b=a(1374),cc=a(992);class fb extends cc.a{constructor(){super();this.isTriggeredBySyncDelta=null;this.H_=Object.assign(new ea.a,{T_:fb.getTypeName(),B_:fb.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}}
Object(N.a)(fb,"DeleteOperation",cc.a,[]);class Sb extends cc.a{constructor(){super();this.isFocused=!1;this.H_=Object.assign(new ea.a,{T_:Sb.getTypeName(),B_:Sb.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_FocusOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}}Object(N.a)(Sb,"FocusOperation",cc.a,[]);var kc=a(1166),na=a(1375);class fc extends na.a{constructor(){super();this.prevParentPath=null;this.H_=Object.assign(new ea.a,{T_:fc.getTypeName(),B_:fc.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_MoveOperation"}static getBaseTypes(){return["AugLoop_Core_OperationWithSiblingContext",
"AugLoop_Core_Operation"]}}Object(N.a)(fc,"MoveOperation",na.a,[]);var Cc=a(1328);class tc extends cc.a{constructor(){super();this.M_=null;this.H_=Object.assign(new ea.a,{T_:tc.getTypeName(),B_:tc.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}}Object(N.a)(tc,"UpdateAnnotationMetaDataOperation",cc.a,[]);var nb=a(1376);class tb extends cc.a{constructor(){super();this.isVisible=!1;this.H_=Object.assign(new ea.a,
{T_:tb.getTypeName(),B_:tb.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static getBaseTypes(){return["AugLoop_Core_Operation"]}}Object(N.a)(tb,"VisibilityOperation",cc.a,[]);class La extends S.a{constructor(){super();this.bridgeId=this.cv=this.messageId=null;this.H_=Object.assign(new ea.a,{T_:La.getTypeName(),B_:La.getBaseTypes()})}static getTypeName(){return"AugLoop_Session_Protocol_Message"}static getBaseTypes(){return[]}}Object(N.a)(La,"Message",S.a,[]);class wb extends La{constructor(){super();
this.activeWorksheetId=null;this.H_=Object.assign(new ea.a,{T_:wb.getTypeName(),B_:wb.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelKeepAlive"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}}Object(N.a)(wb,"ExcelKeepAlive",La,[]);class Wa extends Rb.a{constructor(){super();this.isObserverRequired=this.isSeedingRequired=!1;this.H_=Object.assign(new ea.a,{T_:Wa.getTypeName(),B_:Wa.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}}
Object(N.a)(Wa,"ObserverStatusAnnotation",Rb.a,[]);class Fa extends Rb.a{constructor(){super();this.H_=Object.assign(new ea.a,{T_:Fa.getTypeName(),B_:Fa.getBaseTypes()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_FullSeedingAnnotation"}static getBaseTypes(){return["AugLoop_Core_Annotation"]}}Object(N.a)(Fa,"FullSeedingAnnotation",Rb.a,[]);class Da extends La{constructor(){super();this.parentPath=this.opType=this.seq=this.item=null;this.H_=Object.assign(new ea.a,{T_:Da.getTypeName(),
B_:Da.getBaseTypes()})}static getTypeName(){return"AugLoop_Session_Protocol_MicroSyncMessage"}static getBaseTypes(){return["AugLoop_Session_Protocol_Message"]}}Object(N.a)(Da,"MicroSyncMessage",La,[]);class ja extends S.a{constructor(){super();this.id=null;this.sizeBytes=0;this.dataPointer=this.data=null;this.H_=Object.assign(new ea.a,{T_:ja.getTypeName(),B_:ja.getBaseTypes()})}static getTypeName(){return"AugLoop_Core_Blob"}static getBaseTypes(){return[]}}Object(N.a)(ja,"Blob",S.a,[]);class Qa extends ja{constructor(){super();
this.format=0;this.otherFormat=null;this.size=0;this.isOriginalSize=null;this.H_=Object.assign(new ea.a,{T_:Qa.getTypeName(),B_:Qa.getBaseTypes()})}static getTypeName(){return"AugLoop_Image_ImageContent"}static getBaseTypes(){return["AugLoop_Core_Blob"]}}Object(N.a)(Qa,"ImageContent",ja,[]);class Ob extends S.a{constructor(){super();this.heightPx=this.widthPx=0;this.H_=Object.assign(new ea.a,{T_:Ob.getTypeName(),B_:Ob.getBaseTypes()})}static getTypeName(){return"AugLoop_Image_ImageTileMetadata"}static getBaseTypes(){return[]}}
Object(N.a)(Ob,"ImageTileMetadata",S.a,[]);class Ub extends Ob{constructor(){super();this.contents=null;this.H_=Object.assign(new ea.a,{T_:Ub.getTypeName(),B_:Ub.getBaseTypes()})}static getTypeName(){return"AugLoop_Image_ImageTile"}static getBaseTypes(){return["AugLoop_Image_ImageTileMetadata"]}}Object(N.a)(Ub,"ImageTile",Ob,[]);var Zb=a(113),uc;(function(rb){rb[rb.unknown=0]="unknown";rb[rb.fatal=1]="fatal";rb[rb.yxe=2]="tokenExpired";rb[rb.ptl=3]="modelWorkflowNotSupported";rb[rb.Vsl=4]="largeWorkbooksNotSupported"})(uc||
(uc={}));Object(N.b)("ExcelSessionErrorType",uc);class Hc{constructor(){this.annotations=[]}LV(rb){this.LD=rb;return this}activateAnnotation(rb){if(this.annotations.includes(rb))throw rb=`Annotation from type ${rb.annotationType} was already activated`,I.ULS.sendTraceTag(521216417,0,10,`AugmentationLoopFeatureRegistrationInfoBuilder.activateAnnotation: ${rb}`),Error(rb);this.annotations.push(rb);return this}NV(rb){this.featureName=rb;return this}build(){if(void 0===this.LD)throw I.ULS.sendTraceTag(521216416,
0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Close callback is not set"),Error("Close callback is not set");if(!this.featureName)throw I.ULS.sendTraceTag(521216414,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Feature Name is not set"),Error("Feature Name is not set");return{featureName:this.featureName,LD:this.LD,annotations:this.annotations}}}Object(N.a)(Hc,"AugmentationLoopFeatureRegistrationInfoBuilder",null,[874]);class Dd{constructor(){this.annotationType=void 0;
this.$1b=[]}}Object(N.a)(Dd,"AnnotationDifference",null,[]);var jc;(function(rb){rb.newAnnotation="New";rb.validAnnotation="Valid";rb.invalidAnnotation="Invalid"})(jc||(jc={}));Object(N.b)("AnnotationCallbackType",jc);var $c;(function(rb){rb.newAnnotation="New";rb.validOnArrivalAnnotation="ValidOnArrival";rb.validAfterSomeTimeAnnotation="ValidAfterSomeTime";rb.invalidOnCoauthVersionChangedAnnotation="InvalidOnCoauthVersionChanged";rb.invalidAfterTimeoutAnnotation="InvalidAfterTimeout"})($c||($c={}));
Object(N.b)("AnnotationEventType",$c);var ud;(function(rb){rb[rb.beforeAnnotation=0]="beforeAnnotation";rb[rb.atAnnotation=1]="atAnnotation";rb[rb.afterAnnotation=2]="afterAnnotation"})(ud||(ud={}));Object(N.b)("TimelinePosition",ud);class Ud{constructor(){this.Svb=new Map;I.ULS.sendTraceTag(520176320,0,50,"AugmentationLoopAnnotationValidatorLogger.constructor: called")}X1e(rb){this.Svb.has(rb)||(I.ULS.sendTraceTag(520176291,0,50,`AugmentationLoopAnnotationValidatorLogger.addAnnotationType: ${rb}`),
this.Svb.set(rb,[]))}aqk(rb){this.Svb.delete(rb)&&I.ULS.sendTraceTag(520176290,0,50,`AugmentationLoopAnnotationValidatorLogger.removeAnnotationType: ${rb}`)}W1j(rb,rc){rb.find(ld=>ld.annotationId===rc)||rb.push({annotationId:rc,q5k:Date.now(),umc:$c.newAnnotation})}UFj(rb,rc,ld,Tb){I.ULS.sendTraceTag(520176289,0,50,`AugmentationLoopAnnotationValidatorLogger.logLatencyEntry: type: ${rb}, entry: (${rc.annotationId} ${rc.umc}) incoming: ${Tb}, latency: ${ld-rc.q5k} ms`)}bbj(rb,rc,ld){return(ld===$c.validAfterSomeTimeAnnotation||
ld===$c.validOnArrivalAnnotation)&&(rb.annotationId===rc||rb.umc===$c.invalidAfterTimeoutAnnotation)}T6j(rb,rc,ld,Tb){const Wc=[],Ac=Date.now();let nd=ud.beforeAnnotation;for(const qd of rc){this.bbj(qd,ld,Tb)&&this.UFj(rb,qd,Ac,Tb);if(qd.annotationId===ld){qd.umc=Tb;if(Tb===$c.invalidAfterTimeoutAnnotation)return;nd=ud.atAnnotation}else nd===ud.atAnnotation&&(nd=ud.afterAnnotation);rc=Tb===$c.invalidOnCoauthVersionChangedAnnotation?qd.annotationId!==ld:qd.umc===$c.newAnnotation;const Xd=nd===ud.afterAnnotation;
(nd!==ud.afterAnnotation&&rc||Xd)&&Wc.push(qd)}this.Svb.set(rb,Wc)}$Sj(rb,rc,ld){let Tb=this.Svb.get(rb);Tb||(this.X1e(rb),Tb=this.Svb.get(rb));ld===$c.newAnnotation?this.W1j(Tb,rc):this.T6j(rb,Tb,rc,ld)}}Object(N.a)(Ud,"AugmentationLoopAnnotationValidatorLogger",null,[]);class ec{constructor(rb,rc){this.toString=()=>JSON.stringify(this);this.annotationId=rb;this.coauthVersion=rc}}Object(N.a)(ec,"LocalAnnotationId",null,[]);class Db extends Ca.a{constructor(rb){rb=void 0===rb?36E5:rb;super();this.Ly=
new Map;this.N2=new Map;this.a2a=new Set;this.sBe=new Ud;this.$zf=rb;I.ULS.sendTraceTag(523337872,0,50,`AugmentationLoopAnnotationValidator.constructor: annotationExpirationTimeout: ${this.$zf} ms`)}dispose(){I.ULS.sendTraceTag(523337871,0,50,`AugmentationLoopAnnotationValidator.dispose: ${this.getStatus()}`);this.a2a.clear();this.N2.clear();this.Ly.clear();super.dispose()}W1e(rb,rc,ld){I.ULS.sendTraceTag(521405908,0,50,`AugmentationLoopAnnotationValidator.addAnnotationCallback: annotationType: ${rc}`);
this.addHandler(this.N4d(rb,rc),ld);this.sBe.X1e(rc)}CFg(rb,rc,ld){I.ULS.sendTraceTag(521405907,0,50,`AugmentationLoopAnnotationValidator.removeAnnotationCallback: annotationType: ${rc}`);this.removeHandler(this.N4d(rb,rc),ld);this.sBe.aqk(rc)}D7j(rb){I.ULS.sendTraceTag(523337870,0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: starting, raising CoauthVersionChanged event: ${d(rb)}`);this.Ukj(this.wfb);this.wfb=rb;this.qil(this.wfb);this.$Xf();I.ULS.sendTraceTag(523337869,
0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: done ${this.getStatus()}`)}tAf(rb){if(rb)try{const Wc=JSON.parse(rb);var rc=Wc.coauthVersionDocId,ld=Wc.coauthVersionXluid,Tb=Wc.coauthVersionXrevId;return{DocId:"undefined"===rc?void 0:rc,Xluid:"undefined"===ld?void 0:ld,Xrevid:"undefined"===Tb?void 0:parseInt(Tb,10)}}catch(Wc){I.ULS.sendTraceTag(523337868,0,10,`AugmentationLoopAnnotationValidator.extractWorkbookCoauthVersion(${rb}): Exception - ${Wc}`)}}B4i(rb){var rc;const ld=
null===(rc=this.N2.get(d(this.wfb)))||void 0===rc?void 0:rc.aDa;if(!ld)return[];const Tb=d(this.wfb);return[...ld].map(Wc=>this.Ly.get(`${new ec(Wc,Tb)}`)).filter(Wc=>Wc.annotationType===rb).map(Wc=>Wc.Zpd)}h4g(rb,rc){const ld=this.B4i(rb);I.ULS.sendTraceTag(507795271,0,50,`AugmentationLoopAnnotationValidator.triggerValidCallback: validAnnotationCallback to be called for ${ld.length} annotations of type ${rb}`);ld.forEach(Tb=>{rc(this,Tb)})}bpb(rb,rc,ld){ld=this.tAf(ld);void 0!==ld&&(I.ULS.sendTraceTag(523337867,
0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: starting ${rb}: ${rc.operationType}: (annotation id ${rc.annotation.id}) at ${d(ld)}`),this.oAh({annotationType:rb,Zpd:rc},ld),this.$Xf(),I.ULS.sendTraceTag(523337866,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: done ${this.getStatus()}`))}N4d(rb,rc){return`${rb}_${rc}`}getStatus(){var rb,rc;const ld=d(this.wfb),Tb=null===(rb=this.Ly)||void 0===rb?void 0:rb.size;rb=null===(rc=this.a2a)||void 0===rc?void 0:rc.size;return`current coauth version: ${ld}, ${Tb} known annotations, ${rb} coauth versions on hold`}iSc(rb,
rc,ld,Tb){const Wc=this.Ly.get(`${rc}`);rb=this.N4d(rb,Wc.annotationType);I.ULS.sendTraceTag(523337865,0,50,`AugmentationLoopAnnotationValidator.raiseAnnotationEvent: ${ld} raising ${rb} event (annotation id: ${rc})`);this.raiseEvent(rb,Wc.Zpd,this);this.sBe.$Sj(Wc.annotationType,`${rc}`,Tb)}Gtj(rb,rc){rc=d(this.tAf(rc));rb=`${new ec(rb,rc)}`;return!this.Ly.has(rb)}oAh(rb,rc){var ld=rb.Zpd.annotation.id;const Tb=d(rc);ld=new ec(ld,Tb);const Wc=`${ld}`;this.Ly.has(Wc)?I.ULS.sendTraceTag(523337864,
0,50,`AugmentationLoopAnnotationValidator.addNewAnnotation: ignoring duplicate annotation (annotation id ${ld})`):(this.Ly.set(Wc,rb),this.N2.has(Tb)?this.N2.get(Tb).aDa.add(ld.annotationId):this.N2.set(Tb,{aDa:new Set([ld.annotationId]),timestamp:Date.now()}),rb=this.wfb,rc===rb||rc&&rb&&rc.DocId===rb.DocId&&rc.Xluid===rb.Xluid&&rc.Xrevid===rb.Xrevid?this.iSc("Valid",ld,"addNewAnnotation","ValidOnArrival"):this.a2a.add(d(rc)))}eGg(rb){this.Ly.delete(`${rb}`);for(const rc of this.N2.entries()){const [ld,
Tb]=rc;if(ld===rb.coauthVersion&&Tb.aDa.delete(rb.annotationId))break}}wrk(){Array.from(this.N2.entries()).filter(rb=>{[,rb]=rb;return 0===rb.aDa.size}).forEach(rb=>{[rb]=rb;return this.N2.delete(rb)})}kGg(rb){this.a2a.delete(rb)}Ukj(rb){var rc;const ld=d(rb);(new Set(null===(rc=this.N2.get(ld))||void 0===rc?void 0:rc.aDa)).forEach(Tb=>{Tb=new ec(Tb,ld);this.iSc("Invalid",Tb,"invalidateAnnotations","InvalidOnCoauthVersionChanged");this.eGg(Tb)})}qil(rb){var rc;rb=d(rb);if(this.a2a.has(rb)){var ld=
null===(rc=this.N2.get(rb))||void 0===rc?void 0:rc.aDa;rc=(rc=this.N2.get(rb))?Date.now()-rc.timestamp:0;for(const Tb of ld)ld=new ec(Tb,rb),this.iSc("Valid",ld,`validateAnnotations elapsed ${rc} ms`,"ValidAfterSomeTime");this.kGg(rb)}else I.ULS.sendTraceTag(523337863,0,50,`AugmentationLoopAnnotationValidator.validateAnnotations: ${rb} has no on-hold annotations associated with it`)}$Xf(){var rb=Date.now();const rc=[],ld=[];for(const Wc of this.a2a){var Tb=this.N2.get(Wc);const Ac=rb-Tb.timestamp;
if(Ac>this.$zf)for(const nd of Tb.aDa)Tb=new ec(nd,Wc),this.iSc("Invalid",Tb,`invalidateExpiredAnnotations elapsed ${Ac} ms`,"InvalidAfterTimeout"),rc.push(Tb)}for(const Wc of rc)this.eGg(Wc);for(const Wc of this.a2a)rb=this.N2.get(Wc),0===(null===rb||void 0===rb?void 0:rb.aDa.size)&&ld.push(Wc);for(const Wc of ld)this.kGg(Wc);this.wrk()}}Object(N.a)(Db,"AugmentationLoopAnnotationValidator",Ca.a,[873]);var ic=a(189);class Pc{constructor(){this.Ly=new Map}bpb(rb,rc){const ld=this.Ly.get(rc.annotation.id);
ld&&I.ULS.shipAssertTag(507017041,0,ld.aT.H4a===rc.H4a,`AnnotationPool.onAnnotationReceived: annotationId: ${rc.annotation.id} already exists in the pool for a different runtimeProxyName: ${ld.aT.H4a} vs ${rc.H4a}`);I.ULS.sendTraceTag(508913554,0,50,`AnnotationPool.onAnnotationReceived: ${JSON.stringify({annotationId:rc.annotation.id,annotationType:rb,operationType:rc.operationType,runtimeProxyName:rc.H4a||"None"})}`);this.Ly.set(rc.annotation.id,{annotationType:rb,aT:rc})}ZSj(rb){const rc=this.Ly.delete(rb);
I.ULS.sendTraceTag(508913553,0,50,`AnnotationPool.onAnnotationDeletion: annotationId: ${JSON.stringify({annotationId:rb,hasBeenInThePool:rc})}`)}Yrb(rb){Array.from(this.Ly.entries()).filter(rc=>{[,rc]=rc;return rc.annotationType===rb}).map(rc=>{[rc]=rc;return this.Ly.delete(rc)})}BFf(rb){return this.Ly.get(rb)}kej(rb){rb.forEach(rc=>{var ld;const Tb=S.a.getTypeNameFor(rc.body);rc=new eb(rc.body,null,rc.parentPath,1,void 0);const Wc={annotationType:Tb,aT:rc},Ac=null!==(ld=null===rc||void 0===rc?void 0:
rc.annotation.id)&&void 0!==ld?ld:ic.a.create().toString();this.Ly.set(Ac,Wc);I.ULS.sendTraceTag(508101586,0,50,`AnnotationPool.importAnnotationItems: ${JSON.stringify({annotationId:rc.annotation.id,annotationType:Tb})}`)})}dAf(rb){return rb?Array.from(this.Ly.values()).filter(rc=>rb.includes(rc.annotationType)):Array.from(this.Ly.values())}Mef(rb){if(rb){var rc=Array.from(this.Ly.entries()).filter(Tb=>{[,Tb]=Tb;return Tb.aT.H4a===rb});const ld=rc.map(Tb=>{[,Tb]=Tb;return Tb});I.ULS.sendTraceTag(507270670,
0,50,`AnnotationPool.clearAnnotations: clearing ${ld.length} known annotations for runtimeProxyName: '${rb}'`);rc.map(Tb=>{[Tb]=Tb;return Tb}).forEach(Tb=>this.Ly.delete(Tb));return ld}I.ULS.sendTraceTag(507859419,0,50,`AnnotationPool.clearAnnotations: clearing ${this.Ly.size} known annotations`);rc=Array.from(this.Ly.values());this.Ly.clear();return rc}$Ti(){return Array.from(this.Ly.values())}size(){return this.Ly.size}N3g(rb,rc){this.$Ti().filter(ld=>rb===ld.annotationType).forEach(ld=>{rc(this,
ld.aT)})}}Object(N.a)(Pc,"AnnotationPool",null,[]);var Ed=a(25),de=a(27),se;(function(rb){rb[rb.NonIdPropertiesByHashCalculation=0]="NonIdPropertiesByHashCalculation";rb[rb.ExpectedProperties=1]="ExpectedProperties"})(se||(se={}));Object(N.b)("AnnotationCompareType",se);const Fe={annotationTypes:["AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation","AugLoop_ExcelTableAi_ExcelRecognizedTableNew"],Aqc:1,bxe:1E4},fe=[{name:"singleProxy",features:[],S9:!1}],Tc=[{name:"main",features:["ALManagerInternalAnnotations"],
S9:!1},{name:"secondary",features:["ALManagerInternalAnnotations","TableIntelligence","DataCleansing"],S9:!1}];class ed{constructor(rb,rc,ld){this.zdg=rb;this.Bzi=["Copilot","CopilotWarmupAnnotation"];this.configurations=null!==ld&&void 0!==ld?ld:oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TwoAugLoopRuntimeProxies",!1)?Tc:fe;this.zXh(this.configurations);oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8991073_initializeRuntimeProxiesAsynchronously")||this.Jij(this.configurations,rb,
rc)}async Kij(){this.N9=[];try{this.N9.push(this.LWf(this.zdg,this.configurations[0],!0))}catch(rb){I.ULS.sendTraceTag(507266067,0,10,`AugLoopRuntimeConfigurator.initializeRuntimeProxiesAsync: error initializing the first runtimeProxy '${this.configurations[0].name}': '${rb}'`)}for(let rb=1;rb<this.configurations.length;rb++)try{const rc=await Ma.a.resolve(hb.AugLoopRuntimeProxyTransientService,{xa:0});this.N9.push(this.LWf(rc,this.configurations[rb],!1))}catch(rc){I.ULS.sendTraceTag(507279305,0,
10,`AugLoopRuntimeConfigurator.initializeRuntimeProxiesAsync: error initializing the runtimeProxy '${this.configurations[rb].name}': '${rc}'`)}if(0===this.N9.length)throw I.ULS.sendTraceTag(507266066,0,10,"AugLoopRuntimeConfigurator.initializeRuntimeProxies: no runtimeProxies were initialized"),Error("AugLoopRuntimeConfigurator.initializeRuntimeProxies: no runtimeProxies were initialized");}pxd(rb){this.N9.forEach(rc=>{const ld=Object.assign({},rb);rc.S9&&(ld.n0=()=>{});rc.ftb.pxd(ld)})}submitCustomMessage(rb,
rc){return this.AMg(rc).map(ld=>ld.submitCustomMessage(rb))[0]}T4b(rb,rc){this.AMg(rc).forEach(rb)}Mtd(rb,rc){this.SVc(rc).forEach(rb)}vMg(rb){this.N9.map(rc=>rc.ftb.getAugLoopRuntimeManager()).forEach(rb)}aId(rb){this.N9.forEach(rc=>{rc.ftb&&rb(rc.ftb)})}fqj(rb){return this.N9.some(rc=>rc.features.includes(rb))}Azi(rb){const rc=new Map;for(const ld of rb)rc.set(ld,this.SVc(ld));return rc}GWd(rb,rc){return this.SVc(rb).every(ld=>ld.S9?!0:rc(ld))}Jij(rb,rc,ld){this.N9=[];try{this.N9.push(this.MWf(rc,
rb[0],ld,!0))}catch(Tb){I.ULS.sendTraceTag(507266067,0,10,`AugLoopRuntimeConfigurator.initializeRuntimeProxies: error initializing the first runtimeProxy '${rb[0].name}': '${Tb}'`)}for(let Tb=1;Tb<rb.length;Tb++)Ma.a.resolve(hb.AugLoopRuntimeProxyTransientService,{xa:0}).then(Wc=>{this.N9.push(this.MWf(Wc,rb[Tb],ld,!1))}).catch(Wc=>{I.ULS.sendTraceTag(507279305,0,10,`AugLoopRuntimeConfigurator.initializeRuntimeProxies: error initializing the runtimeProxy '${rb[Tb].name}': '${Wc}'`)});if(0===this.N9.length)throw I.ULS.sendTraceTag(507266066,
0,10,"AugLoopRuntimeConfigurator.initializeRuntimeProxies: no runtimeProxies were initialized"),Error("AugLoopRuntimeConfigurator.initializeRuntimeProxies: no runtimeProxies were initialized");}LWf(rb,rc,ld){rb.OWf(rc.name,null,ld,rc.S9);rc=Object.assign({},rc);rc.ftb=rb;return rc}MWf(rb,rc,ld,Tb){ld=Object.assign({},ld);rc.S9&&(ld.n0=()=>{});rb.OWf(rc.name,ld,Tb,rc.S9);rc=Object.assign({},rc);rc.ftb=rb;return rc}zXh(rb){I.ULS.shipAssertTag(507090015,0,!rb[0].S9,"AugLoopRuntimeConfigurator.checkFeatureAssignments: first configuration element must not be for selfTestMode");
var rc=rb.filter(ld=>ld.features.some(Tb=>Tb.startsWith("x10")));I.ULS.shipAssertTag(507323875,0,1>=rc.length,"AugLoopRuntimeConfigurator.checkFeatureAssignments: X10 features are assigned to more than one runtime. This is not allowed.");for(rc=1;rc<rb.length;rc++)rb[rc].S9||I.ULS.shipAssertTag(507279304,0,!rb[rc].features.some(ld=>this.Bzi.includes(ld)),"AugLoopRuntimeConfigurator.checkFeatureAssignments: Copilot can be assigned to the 1st runtime only.")}SVc(rb){const rc=this.N9.filter(ld=>ld.features.includes(rb)).map(ld=>
ld.ftb);return 0<rc.length?rc:[this.zdg]}AMg(rb){return this.SVc(rb).map(rc=>rc.getAugLoopRuntimeManager())}}Object(N.a)(ed,"AugLoopRuntimeConfigurator",null,[]);var pd=a(1377);Object(Ma.b)(hb.AugmentationLoopManagerService,{we:"singleton"})(async rb=>{const rc=await Ma.a.resolve(hb.EwaControlService,rb);rb=await Ma.a.resolve(hb.AugLoopRuntimeProxyService,rb);if(oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8991073_initializeRuntimeProxiesAsynchronously"))try{const ld=new ed(rb,void 0);await ld.Kij();
const Tb=new Kb(rc,rb,ld);ld.pxd(Tb.ZJi());return Tb}catch(ld){return I.ULS.sendTraceTag(507017362,0,10,`AugmentationLoopManagerService: failed with error ${ld}`),null}else return new Kb(rc,rb,null)});class Kb extends Ca.a{constructor(rb,rc,ld,Tb,Wc){Tb=void 0===Tb?new Db(rb.ta.AugmentationLoopAnnotationExpirationTimeoutInMs):Tb;Wc=void 0===Wc?ba.a.zb:Wc;var Ac,nd;super();this.$=rb;this.aba=rc;this.BE=ld;this.Fqa=Tb;this.vj=Wc;this.Nwa=null;this.isObserverRequired=!1;this.Yf=null;this.rXd=!1;this.vL=
new Map;this.Ypd=[];this.Mxi=new Map([[0,"Unknown"],[1,"Permanent"],[2,"Permanent"],[3,"ModelWorkflowNotSupported"],[4,"ModelWorkflowNotSupported"]]);this.$pd=this.accessTokenExpirationManager=null;this.G4c=new Ga;this.bda=oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopIncrementalChangesPhase1",!1);this.Rej=oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugLoop.IncrementalChangesForClp",!1);this.Eqa=this.bda?new Pc:null;this.uqf=oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopSanityEndToEndTest",
!1);this.b3=oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8913655_MultipleRuntimeProxiesPart3");this.Adg=oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8874237_makeCallbackTriggeringNotAsync");this.ZJi=()=>({n0:this.n0.bind(this),WTa:this.g_b.bind(this),j_a:this.isLargeWorkbookSession.bind(this)});this.hZ=()=>{const qd=this.$.fa.Yf.xp,Xd=this.$.isEditMode;qd&&Xd?this.b3?this.BE.aId(Hd=>{Hd.forceReconnectSession("AugmentationLoopManager.onTokenRefreshed")}):this.aba.forceReconnectSession("AugmentationLoopManager.onTokenRefreshed"):
I.ULS.sendTraceTag(507556740,0,50,`AugmentationLoopManager.onTokenRefreshed: user is inactive or not in edit mode, returning with no-op. isUserActive: ${qd}, isEditMode: ${Xd}`)};this.yd=(qd,Xd)=>{Xd.nI&&this.$.fa.sessionId&&(I.ULS.sendTraceTag(537170394,0,50,"AugmentationLoopManager.onSessionIdChanged: Update augmentation loop server on new ECS Session ID"),this.b3?this.BE.aId(Hd=>{Hd.forceReconnectSession("AugmentationLoopManager.onSessionIdChanged")}):this.aba.forceReconnectSession("AugmentationLoopManager.onSessionIdChanged"),
this.Yne(this.isObserverRequired,"onSessionIdChanged"),void this.Jsf())};this.J2=()=>this.aba.J2;this.onActiveItemChanged=(qd,Xd)=>{qd=Object(mb.o)(Xd.la)?Object(mb.d)(Xd.la):this.activeWorksheetId;Xd=oa.EwaSettings.isChangeGateEnabled("OfficeVSO:7547289_ALCloseALSessionOnInvalidAccessToken")?this.hcf()&&qd&&qd!==this.activeWorksheetId:qd&&qd!==this.activeWorksheetId;this.activeWorksheetId=qd;Xd&&(this.R0d=this.vj.Jc,I.ULS.sendTraceTag(520677595,0,50,`AugmentationLoopManager.onActiveItemChanged: Submitting keepalive custom message. activeSheetId ${this.activeWorksheetId}`),
this.XOg())};this.g_b=(qd,Xd,Hd)=>{3===qd.tH?I.ULS.sendTraceTag(508143578,0,15,"AugmentationLoopManager.onCloseMessage: Called while augmentation loop server is closed. Avoiding with early return"):(I.ULS.sendTraceTag(508143577,0,50,`AugmentationLoopManager.onCloseMessage called with shouldRetry: ${Xd}, isWebsocketToAugloopActive=${this.J2()}, closeMessage: ${JSON.stringify(Hd)}`),this.bda&&this.Eqa.Mef(qd.name),this.Yne(!1,"onCloseMessage"),Xd?this.Rue(qd):this.Y8i(qd,Hd.reason))};this.o_h=qd=>{switch(S.a.getTypeNameFor(qd)){case Oa.getTypeName():return uc[null===
qd||void 0===qd?void 0:qd.errorType];case Ha.getTypeName():return qd.reasonDescription;default:return"unknown"}};this.Y8i=(qd,Xd)=>{I.ULS.sendTraceTag(507777541,0,50,`AugmentationLoopManager.handleNoRetryCloseMessage: closeReasonForWidget: ${this.o_h(Xd)}`);this.jve();let Hd=null;switch(S.a.getTypeNameFor(Xd)){case Oa.getTypeName():var Zc=Xd.errorType;const Jc=Xd.errorCode,gc=this.Lxi(Zc);this.lUh(qd,gc,Jc);4===Zc?this.rXd=!0:oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8809246_ALWorkbookLimitDecreaseFix")&&
3===Zc&&(this.rXd=!1);break;case Ha.getTypeName():Zc=Xd.reasonDescription;"ClientRequested"!==Zc&&(Hd=`AugmentationLoopManager.handleNoRetryCloseMessage: closeReason.reasonDescription is not recognized; reasonDescription: ${Zc}`);break;default:Hd=`AugmentationLoopManager.handleNoRetryCloseMessage: closeReason type is not recognized; closeReason: ${JSON.stringify(Xd)}`}Xd=this.vIi(Xd);qd.tH=Xd;2===Xd&&this.Rue(qd);null!==Hd&&I.ULS.shipAssertTag(508147337,0,!1,Hd)};this.jd=(qd,Xd)=>{if(Xd.Hg)I.ULS.sendTraceTag(520677599,
0,50,"AugmentationLoopManager.onWorkbookClosing: event triggered due to silent reopen. Avoiding event with early return");else if(I.ULS.sendTraceTag(537170381,0,50,`AugmentationLoopManager.onWorkbookClosing: handler invoked
      (IsAppBeforeUnload == ${this.$.fZa}, IsAppUnloading == ${this.$.gU}.`),this.$.fZa||this.$.gU)this.jve(),this.BE.vMg(Hd=>{Hd.closeSession().catch(Zc=>{I.ULS.sendTraceTag(526406240,0,50,`AugmentationLoopManager.onWorkbookClosing: closeSession promise rejected with error ${Zc}`)})})};this.n0=(qd,Xd)=>{I.ULS.sendTraceTag(537170380,0,50,"Annotation received, runtimeProxyName = "+Xd);if(qd)if(qd.items){var Hd=0;({value:Hd}=this.Nwa.Od(S.a.getTypeNameFor(qd),0));0===Hd?I.ULS.sendTraceTag(537170377,
0,10,"AugmentationLoopManager.annotationCallback: Operation Type not supported "+S.a.getTypeNameFor(qd)):3===Hd?this.z7i(qd):this.O6i(qd,Hd,Xd)}else I.ULS.sendTraceTag(537170378,0,10,"AugmentationLoopManager.annotationCallback: Operation has no items");else I.ULS.sendTraceTag(537170379,0,10,"AugmentationLoopManager.annotationCallback: Operation is null")};this.pKa=()=>{const qd=aa.b(this.vj,this.R0d);if(oa.EwaSettings.isChangeGateEnabled("OfficeVSO:7547289_ALCloseALSessionOnInvalidAccessToken"))var Xd=
this.hcf()&&this.U5d<=qd;else{Xd=this.$.fa.G7;const Hd=this.$.fa.I4;Xd=this.U5d<=qd&&Hd<this.W6a&&!Xd}Xd?(this.R0d=this.vj.Jc,I.ULS.sendTraceTag(509682396,0,50,`AugmentationLoopManager.onUserActivityThrottled: Submitting keepalive custom message. secondsSinceLastKeepAlive: ${qd}`),this.XOg()):this.U5d<=qd&&I.ULS.sendTraceTag(520632032,0,50,`AugmentationLoopManager.onUserActivityThrottled: Not submitting keepalive custom message. secondsSinceLastKeepAlive: ${qd}`)};this.yFi=(qd,Xd)=>{I.ULS.sendTraceTag(507859418,
0,50,"AugmentationLoopManager.fullSeedingAnnotationHandler: Called.");qd=this.Eqa.Mef(Xd.H4a);for(const Hd of qd)this.qBg(Hd)};this.WRj=(qd,Xd)=>{qd=Xd.annotation;I.ULS.shipAssertTag(537170373,306,!!qd,"AugmentationLoopManager.ObserverStatusAnnotationHandler: ObserverStatusAnnotation is null.");I.ULS.sendTraceTag(520677594,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: received ${JSON.stringify(qd)}`);this.isObserverRequired=qd.isSeedingRequired&&qd.isObserverRequired;this.Yne(this.isObserverRequired,
"observerStatusAnnotationHandler")};this.uac=(qd,Xd)=>{var Hd;(null===(Hd=null===Xd||void 0===Xd?void 0:Xd.Ge)||void 0===Hd?0:Hd.WorkbookCoauthVersion)&&this.E7j(Xd.Ge.WorkbookCoauthVersion,Xd.context)};if(!(oa.EwaSettings.PQ()||rb&&rc))throw I.ULS.sendTraceTag(507511822,0,15,"AugmentationLoopManager.constructor: EwaControl or AugLoopRuntimeProxy could not be initialized."),Error("AugmentationLoopManager.constructor: EwaControl or AugLoopRuntimeProxy could not be initialized.");this.R0d=this.vj.Jc;
this.activeWorksheetId=null!==(Ac=Object(mb.d)(rb.la))&&void 0!==Ac?Ac:this.activeWorksheetId;I.ULS.sendTraceTag(520679433,0,50,`AugmentationLoopManager.constructor: setAnnotationResultCallback ${null===(nd=this.n0)||void 0===nd?void 0:nd.name}, activeWorksheetId ${this.activeWorksheetId}`);oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8991073_initializeRuntimeProxiesAsynchronously")||(this.BE=new ed(this.aba,{n0:this.n0.bind(this),WTa:this.g_b.bind(this),j_a:this.isLargeWorkbookSession.bind(this)}));
this.lij();this.$.Sj(this.jd);this.U5d=this.$.ta.MinimumSecondsBetweenKeepAlivesFromBrowserToAugloop;this.W6a=60*this.$.ta.UserActiveTimeSinceLastActivityInMinutes;this.$.fa.Vk(this.yd);this.$.wc.mh(this.onActiveItemChanged);this.$.qa.mh(this.onActiveItemChanged);this.$.ma.ED(this.uac);this.bda&&this.hfj();this.Dfj();this.jok();this.uqf&&(this.R6e=new Pc,M(rb,this.R6e,this));hb.AccessTokenManagerService.Oa()&&oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8994066_UpdateNewUserAccessTokenV2")?void Ma.a.Bd(hb.AccessTokenManagerService).then(qd=>
{this.accessTokenExpirationManager=qd;this.accessTokenExpirationManager.uqa(this.hZ);I.ULS.sendTraceTag(507556742,0,50,"AugmentationLoopManager.constructor: registered onTokenRefreshed event handler with new access token service")}):oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8994066_UpdateNewUserAccessTokenV2")&&this.$.ra.Vc(38,qd=>{this.accessTokenExpirationManager=qd;this.accessTokenExpirationManager.uqa(this.hZ);I.ULS.sendTraceTag(507556741,0,50,"AugmentationLoopManager.constructor: registered onTokenRefreshed event handler with old access token service")});
void this.Jsf()}Dfj(){oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopTableLintRecognitionPullWorkflowsCompare",!1)&&this.Ypd.push("ExcelTableRecognitionReducer");I.ULS.sendTraceTag(508683610,0,50,`AugmentationLoopManager.initFilteredOutAnnotations: ${this.Ypd.join(",")}`)}hfj(){this.$pd=[];this.Rej&&this.$pd.push(pd.a.getTypeName())}hcf(){const rb=this.$.fa.G7;return 300>this.$.fa.I4&&!rb}XOg(){this.b3?this.BE.aId(rb=>{rb.J2||I.ULS.sendTraceTag(508376342,0,50,`AugmentationLoopManager.sendExcelKeepAliveMessage: augloop websocket is disconnected, expecting ExcelKeepAlive send to fail. runtimeProxy name: ${rb.name}`)}):
this.J2()||I.ULS.sendTraceTag(508376342,0,50,"AugmentationLoopManager.sendExcelKeepAliveMessage: augloop websocket is disconnected, expecting ExcelKeepAlive send to fail");this.BE.vMg(rb=>{rb.submitCustomMessage(Object(K.a)(new da.a,{message:Object(K.a)(new wb,{activeWorksheetId:this.activeWorksheetId})})).catch(rc=>{I.ULS.sendTraceTag(526406239,0,10,`AugmentationLoopManager.sendExcelKeepAliveMessage: submitCustomMessage promise rejected with error ${rc}`)})})}RT(){return new Hc}pyh(rb){rb.dO&&this.pAh(rb.annotationType,
rb.dO);this.bda&&this.vmb(rb.annotationType)?rb.kBd&&this.izh(rb.annotationType,rb.kBd):(rb.Rna&&this.Fqa.W1e("Valid",rb.annotationType,rb.Rna),rb.jTb&&this.Fqa.W1e("Invalid",rb.annotationType,rb.jTb))}$pk(rb){rb.dO&&this.Xqk(rb.annotationType,rb.dO);this.bda&&this.vmb(rb.annotationType)?rb.kBd&&this.oqk(rb.annotationType,rb.kBd):(rb.Rna&&this.Fqa.CFg("Valid",rb.annotationType,rb.Rna),rb.jTb&&this.Fqa.CFg("Invalid",rb.annotationType,rb.jTb))}register(rb){let rc=null,ld;if(this.vL.has(rb.featureName))rc=
`${rb.featureName} is already registered. Ignoring new registration.`,ld="AlreadyRegisteredFailure";else if(this.b3?this.wYf(rb.featureName):3===this.aba.tH)rc=`Augmentation loop server is permanently closed. Cannot register ${rb.featureName}.`,ld="ServerClosedFailure";if(rc)return I.ULS.sendTraceTag(509649306,0,15,`AugmentationLoopManager.register: ${rc}`),ld;I.ULS.sendTraceTag(509686223,0,50,`AugmentationLoopManager.register: Registering ${rb.featureName}`);rb.annotations=rb.annotations.filter(Tb=>
this.zEg(rb.featureName,Tb));this.vL.set(rb.featureName,rb);return"Success"}unregister(rb){const rc=this.vL.get(rb);if(!rc)return I.ULS.sendTraceTag(509686220,0,15,`AugmentationLoopManager.unregister: feature ${rb} is not registered`),"UnregisteredFeatureFailure";I.ULS.sendTraceTag(509686221,0,50,`AugmentationLoopManager.unregister: unregister ${rb}`);this.vL.delete(rb);rc.annotations.forEach(ld=>{this.c6g(ld)});return"Success"}Lxi(rb){var rc;return null!==(rc=this.Mxi.get(rb))&&void 0!==rc?rc:"Unknown"}Ikk(rb){switch(rb.tH){case 0:this.vL.forEach(rc=>
{rc.annotations.forEach(ld=>{this.activateAnnotation(ld)})});break;case 2:this.vL.forEach(rc=>{rc.annotations.filter(ld=>!ld.ls).forEach(ld=>{this.activateAnnotation(ld)})});break;case 1:case 3:I.ULS.shipAssertTag(509661458,0,!1,`AugmentationLoopManager.reactivateAnnotationsBasedOnModelSupported: Called while augmentation loop server is ${Z[rb.tH]}`)}}isLargeWorkbookSession(rb){(rb=oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugLoop.ExcelIncreaseCopilotCellLimit",!1)&&2===rb&&!this.rXd&&
this.vL.has("CopilotWarmupAnnotation"))&&I.ULS.sendTraceTag(507529025,0,50,"AugmentationLoopManager.isLargeWorkbookSession: init LargeWorkbook session.");return rb}vIi(rb){if(S.a.getTypeNameFor(rb)===Oa.getTypeName())switch(rb.errorType){case 3:case 4:a:{rb=this.vL;for(rc of rb.values())for(const ld of rc.annotations)if(!ld.isInternal&&!ld.ls){var rc=!0;break a}rc=!1}return rc?2:1;default:return 3}else return 3}yLc(rb){return`New_${rb}`}L4d(rb){return`Delete_${rb}`}pAh(rb,rc){I.ULS.sendTraceTag(520679429,
0,50,`AugmentationLoopManager.addNewAnnotationCallback: annotationType: ${rb}, handler: ${null===rc||void 0===rc?void 0:rc.name}`);this.addHandler(this.yLc(rb),rc)}Xqk(rb,rc){I.ULS.sendTraceTag(509686219,0,50,`AugmentationLoopManager.removeNewAnnotationCallback: annotationType: ${rb}, handler: ${null===rc||void 0===rc?void 0:rc.name}`);this.removeHandler(this.yLc(rb),rc)}izh(rb,rc){I.ULS.sendTraceTag(508913552,0,50,`AugmentationLoopManager.addDeleteAnnotationCallback: annotationType: ${rb}, handler: ${null===
rc||void 0===rc?void 0:rc.name}`);this.addHandler(this.L4d(rb),rc)}oqk(rb,rc){I.ULS.sendTraceTag(508913551,0,50,`AugmentationLoopManager.removeDeleteAnnotationCallback: annotationType: ${rb}, handler: ${null===rc||void 0===rc?void 0:rc.name}`);this.removeHandler(this.L4d(rb),rc)}Myh(rb){I.ULS.sendTraceTag(520679427,0,50,"AugmentationLoopManager.addCoauthVersionChangedCallback");this.addHandler("CoauthVersionChanged",rb)}zEg(rb,rc){if((this.b3?this.Hlj(rb):0!==this.aba.tH)&&rc.ls)return I.ULS.sendTraceTag(509650462,
0,50,`AugmentationLoopManager.registerAnnotationInternal: Augmentation loop server does not support model workflow. Cannot activate ${rc.annotationType}.`),!1;if(rc.isInternal&&this.Glj(rb))return!1;this.b3?this.W_k(rb,!rc.ls):this.yZg(this.aba,!rc.ls);this.wZg();this.pyh(rc);this.Adg&&f(this.vL,rc.annotationType)&&(this.bda&&this.vmb(rc.annotationType)?this.Eqa.N3g(rc.annotationType,rc.dO):this.Fqa.h4g(rc.annotationType,rc.Rna));this.activateAnnotation(Object.assign({},rc,{featureName:rb}));return!0}Iea(rb,
rc){let ld=null,Tb;const Wc=this.vL.get(rb);Wc?Wc.annotations.some(Ac=>rc.annotationType===Ac.annotationType)?(ld=`Annotation ${rc.annotationType} is already registered for feature ${rb}.`,Tb="AlreadyRegisteredFailure"):this.b3?this.wYf(rb)&&(ld=`Augmentation loop server is permanently closed. Cannot activate ${rc.annotationType}.`,Tb="ServerClosedFailure"):3===this.aba.tH&&(ld=`Augmentation loop server is permanently closed. Cannot activate ${rc.annotationType}.`,Tb="ServerClosedFailure"):(ld=`Feature ${rb} is not registered. Cannot register ${rc.annotationType}.`,
Tb="UnregisteredFeatureFailure");if(ld)return I.ULS.sendTraceTag(509682975,0,15,`AugmentationLoopManager.registerAnnotation: ${ld}`),Tb;I.ULS.sendTraceTag(509686218,0,50,`AugmentationLoopManager.registerAnnotation: Registering annotation ${rc.annotationType} for feature ${rb}.`);this.zEg(rb,rc)&&Wc.annotations.push(rc);return"Success"}fal(rb){const rc=this.vL.get("AutoPolicy");if(rc){I.ULS.sendTraceTag(509367457,0,50,`AugmentationLoopManager.unregisterAnnotation: Unregister annotation ${rb} for feature ${"AutoPolicy"}.`);
var ld=rc.annotations.findIndex(Tb=>Tb.annotationType===rb);if(-1!==ld){const Tb=rc.annotations[ld];rc.annotations.splice(ld,1);this.c6g(Tb)}}else I.ULS.sendTraceTag(509367458,0,15,"AugmentationLoopManager.unregisterAnnotation: Feature AutoPolicy is not registered.")}c6g(rb){this.LAd(rb);this.$pk(rb);this.bda&&(f(this.vL,rb.annotationType)||this.Eqa.Yrb(rb.annotationType))}Rue(rb){I.ULS.sendTraceTag(509661457,0,50,"AugmentationLoopManager.startNewALSession: Starting new AL session.");rb.getAugLoopRuntimeManager().startNewSession();
this.wZg();this.Ikk(rb)}W_k(rb,rc){this.BE.Mtd(ld=>{this.yZg(ld,rc)},rb)}yZg(rb,rc){I.ULS.shipAssertTag(509650461,0,3!==rb.tH,"AugmentationLoopManager.startNewALSessionIfNecessary: Called while augmentation loop server is closed permanently.");1===rb.tH&&rc&&(rb.tH=2,this.Rue(rb))}activateAnnotation(rb){rb.cqj?I.ULS.sendTraceTag(508347874,0,50,`AugmentationLoopManager.activateAnnotation: Skipping activation of annotation type: ${rb.annotationType} because it's a fake annotation.`):(I.ULS.sendTraceTag(520679425,
0,50,`AugmentationLoopManager.activateAnnotation: Activating annotation type: ${rb.annotationType}, isModelRequired: ${rb.ls}.`),this.b3?this.BE.Mtd(rc=>{rc.J2||I.ULS.sendTraceTag(508376341,0,15,`AugmentationLoopManager.activateAnnotation: augloop websocket for runtime proxy '${rc.name}' is disconnected, expecting '${rb.annotationType}' activation to fail`)},rb.featureName):this.J2()||I.ULS.sendTraceTag(508376341,0,15,`AugmentationLoopManager.activateAnnotation: augloop websocket is disconnected, expecting '${rb.annotationType}' activation to fail`),
this.BE.T4b(rc=>{rc.activateAnnotation(Object(K.a)(new Yb,{annotationType:rb.annotationType,stateUpdateHandler:rb.tql})).then(ld=>{if(ld){this.Adg||f(this.vL,rb.annotationType)&&(this.bda&&this.vmb(rb.annotationType)?this.Eqa.N3g(rb.annotationType,rb.dO):this.Fqa.h4g(rb.annotationType,rb.Rna));var Tb=this.vL.get(rb.featureName);(Tb=null===Tb||void 0===Tb?void 0:Tb.annotations.find(Wc=>Wc.annotationType===rb.annotationType))?Tb.P6e=ld.token:I.ULS.sendTraceTag(507885148,0,15,`AugmentationLoopManager.activateAnnotation: annotationInfoInRegistry is undefined for feature ${rb.featureName}, annotationType ${rb.annotationType}`)}else I.ULS.sendTraceTag(520677603,
0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");return null}).catch(ld=>{I.ULS.sendTraceTag(520677602,0,50,`AugmentationLoopManager.activateAnnotation: activateAnnotation promise rejected with error ${ld}`)})},rb.featureName))}LAd(rb){rb.P6e?this.BE.T4b(rc=>{rc.releaseAnnotation({token:rb.P6e}).then(ld=>{ld||I.ULS.sendTraceTag(507893770,0,15,`AugmentationLoopManager.deactivateAnnotation: ReleaseAnnotationResult is False for annotation ${rb.annotationType}, featureName: ${rb.featureName}`);
return null}).catch(ld=>{I.ULS.sendTraceTag(507893769,0,15,`AugmentationLoopManager.deactivateAnnotation: releaseAnnotation promise rejected with error ${ld}, featureName: ${rb.featureName}`)})},rb.featureName):I.ULS.sendTraceTag(507893768,0,15,`AugmentationLoopManager.deactivateAnnotation: annotationActivationToken is not available for annotation '${rb.annotationType}', featureName: '${rb.featureName}'`)}submitOperation(rb,rc){if(!rb)return I.ULS.shipAssertTag(537170387,0,!1,`AugmentationLoopManager.submitOperation: operation is null, feature '${rc}'`),
"InvalidParameterFailure";rc&&this.DIb(rc,"submitOperation");const ld=S.a.getTypeNameFor(rb);I.ULS.sendTraceTag(537170386,0,50,`AugmentationLoopManager.submitOperation: submitting operation of type '${ld}', for feature: '${rc}'`);this.b3?this.x6f(rc,`AugmentationLoopManager.submitOperation for '${ld}'`):this.J2()||I.ULS.sendTraceTag(508376340,0,50,`AugmentationLoopManager.submitOperation: augloop websocket is disconnected, expecting send '${ld}' to fail`);this.BE.T4b(Tb=>{Tb.submitOperation(Object(K.a)(new Mb,
{operation:rb}))},rc);return"Success"}qvb(rb,rc){if(!rb)return I.ULS.shipAssertTag(537170385,0,!1,`AugmentationLoopManager.submitOperationSignal: signal is null, feature '${rc}'`),"InvalidParameterFailure";rc&&this.DIb(rc,"submitOperationSignal");const ld=Object.getTypeName(rb);I.ULS.sendTraceTag(537170384,0,50,`AugmentationLoopManager.submitOperationSignal: submitting operation signal of type '${ld}', for feature '${rc}'`);if(this.b3){if(this.x6f(rc,`AugmentationLoopManager.submitOperationSignal, signalType '${ld}'`))return"DisconnectedFromAugloop"}else if(!this.J2())return I.ULS.sendTraceTag(508380384,
0,15,`AugmentationLoopManager.submitOperationSignal: could not submit signal of type '${ld}' because augloop websocket is disconnected`),"DisconnectedFromAugloop";this.BE.T4b(Tb=>{Tb.submitOperation(Object(K.a)(new Mb,{operation:Object(K.a)(new Cc.a,{parentPath:["Signal",Object.getTypeName(rb)],items:[Object(K.a)(new kc.a,{body:rb})]})}))},rc);return"Success"}registerLocalWorkflow(rb,rc){if(!rb)return I.ULS.shipAssertTag(537170383,0,!1,`AugmentationLoopManager.registerLocalWorkflow: workflow is null, feature: '${rc}'`),
"InvalidParameterFailure";rc&&this.DIb(rc,"registerLocalWorkflow");I.ULS.sendTraceTag(537170382,0,50,`AugmentationLoopManager.registerLocalWorkflow: registering local workflow '${rb.id}', for feature: '${rc}'`);this.BE.T4b(ld=>{ld.registerLocalWorkflow(Object(K.a)(new Gb,{workflow:rb}))},rc);return"Success"}ugl(rb,rc,ld,Tb){this.DIb("DataFromPicture","uploadImage");rb=Object(K.a)(new Ub,{heightPx:Tb,widthPx:ld,contents:[Object(K.a)(new Qa,{id:rc+".0",format:2,size:3,sizeBytes:rb.length,data:rb})]});
rc=Object(K.a)(new kc.a,{id:rc,body:rb});rc=Object(K.a)(new Da,{item:rc});I.ULS.sendTraceTag(520677600,0,50,"AugmentationLoopManager.uploadImage: submitting custom message, for feature: 'DataFromPicture'");this.BE.submitCustomMessage(Object(K.a)(new da.a,{message:rc}),"DataFromPicture").catch(Wc=>{I.ULS.sendTraceTag(526406241,0,50,`AugmentationLoopManager.uploadImage: for feature: '${"DataFromPicture"}', submitCustomMessage promise rejected with error '${Wc}'`);return"UnknownFailure"})}dispose(){this.$&&
this.$.fa&&this.$.fa.Qk(this.yd);this.$&&this.$.wc&&(this.$.wc.xh(this.onActiveItemChanged),this.$.qa.xh(this.onActiveItemChanged));this.$&&this.$.ma&&this.$.ma.xG(this.uac);oa.EwaSettings.isChangeGateEnabled("OfficeVSO:8994066_UpdateNewUserAccessTokenV2")&&this.accessTokenExpirationManager&&(this.accessTokenExpirationManager.lsb(this.hZ),I.ULS.sendTraceTag(507556739,0,50,"AugmentationLoopManager.dispose: unregistered onTokenRefreshed event handler."));this.jve();super.dispose()}vmb(rb){return this.$pd.includes(rb)}wZg(){this.Yf||
(this.Yf=this.$.fa.Yf,this.Yf.QCa(this.pKa))}jve(){this.Yf&&(this.Yf.zLa(this.pKa),this.Yf=null)}lUh(rb,rc,ld){if(this.b3){if(!rb.S9){var Tb=0===rb.tH,Wc=this.BE.Azi(this.vL.keys());for(const Ac of this.vL){const [nd,qd]=Ac;if(Wc.get(nd).includes(rb)&&(Tb||!qd.annotations.every(Xd=>Xd.ls)))try{qd.LD(rc,ld)}catch(Xd){I.ULS.sendTraceTag(509674971,0,10,`AugmentationLoopManager.callAugloopCloseCallbacks: caught exception from ${qd.featureName} close callback with message: ${Xd.message}`)}}}}else for(Tb of this.vL.values())if(0===
this.aba.tH||!Tb.annotations.every(Ac=>Ac.ls))try{Tb.LD(rc,ld)}catch(Ac){I.ULS.sendTraceTag(509674971,0,10,`AugmentationLoopManager.callAugloopCloseCallbacks: caught exception from ${Tb.featureName} close callback with message: ${Ac.message}`)}}lij(){this.Nwa=new Zb.a;this.Nwa.ga($b.a.getTypeName(),1);this.Nwa.ga(nb.a.getTypeName(),2);this.Nwa.ga(fc.getTypeName(),5);this.Nwa.ga(fb.getTypeName(),3);this.Nwa.ga(tb.getTypeName(),7);this.Nwa.ga(Sb.getTypeName(),6);this.Nwa.ga(tc.getTypeName(),4)}DIb(rb,
rc){const ld=this.vL.has(rb),Tb=this.BE.fqj(rb);ld||Tb||I.ULS.sendTraceTag(507316125,0,10,`AugmentationLoopManager.checkFeatureRegisteredOrAssignedToRuntime: Feature '${rb}' is not registered or assigned to runtime. Caller function: '${rc}'`)}O6i(rb,rc,ld){1!==rc&&I.ULS.sendTraceTag(508904538,0,15,`AugmentationLoopManager.handleAddOrUpdateOperation: handling operation of type ${rc}`);for(const Wc of rb.items){if(!Wc){I.ULS.sendTraceTag(537170376,0,10,"AugmentationLoopManager.handleAddOrUpdateOperation: Error in item");
continue}if(!Wc.body||!this.isAnnotation(Wc.body)){I.ULS.sendTraceTag(537170375,0,10,"AugmentationLoopManager.handleAddOrUpdateOperation: Body is either null or not an annotation.");continue}var Tb=Wc.source;if(this.Ypd.includes(Tb)){I.ULS.sendTraceTag(520677597,0,100,`AugmentationLoopManager.handleAddOrUpdateOperation: Filtered out annotation of owner ${Tb}`);continue}Tb=S.a.getTypeNameFor(Wc.body);if(!Tb){I.ULS.sendTraceTag(523329624,0,50,"AugmentationLoopManager.handleAddOrUpdateOperation: annotationType is null");
continue}const Ac=Wc.body;if(!Ac){I.ULS.sendTraceTag(523329623,0,50,"AugmentationLoopManager.handleAddOrUpdateOperation: annotation is null");continue}I.ULS.sendTraceTag(576271178,0,50,`AugmentationLoopManager.handleAddOrUpdateOperation: Triggering Event handler for Annotation ${Tb}. ParentRevId: ${rb.parentRevId}`);const nd=new eb(Ac,null,rb.parentPath,rc,ld);this.uqf&&this.R6e.bpb(Tb,nd);this.bda&&this.vmb(Tb)?(this.Eqa.BFf(Ac.id)&&I.ULS.sendTraceTag(508678295,0,50,`AugmentationLoopManager.handleAddOrUpdateOperation: received annotation whose Id is already in the pool, annotationType: ${Tb}, id: ${Ac.id}, operationType: ${rc}`),
this.Eqa.bpb(Tb,nd),this.raiseEvent(this.yLc(Tb),nd,this),I.ULS.sendTraceTag(508678338,0,100,`AugmentationLoopManager.handleAddOrUpdateOperation: raising newAnnotation event (annotation type: ${Tb})`)):(this.Fqa.Gtj(nd.annotation.id,rb.parentRevId)&&(this.raiseEvent(this.yLc(Tb),nd,this),I.ULS.sendTraceTag(520677596,0,100,`AugmentationLoopManager.handleAddOrUpdateOperation: raising newAnnotation event (annotation type: ${Tb})`)),this.Fqa.bpb(Tb,nd,rb.parentRevId))}}isAnnotation(rb){return S.a.getTypeNameFor(rb)===
Rb.a.getTypeName()||0<=Array.indexOf(S.a.getBaseTypesFor(rb),Rb.a.getTypeName())}z7i(rb){for(const rc of rb.items)if(!rc)I.ULS.sendTraceTag(508913550,0,10,"AugmentationLoopManager.handleDeleteOperation: Error in item");else if(!rc.id)I.ULS.sendTraceTag(508913549,0,10,"AugmentationLoopManager.handleDeleteOperation: Item had no id");else if(this.bda){const ld=this.Eqa.BFf(rc.id);ld&&this.vmb(ld.annotationType)&&(rb.parentPath!==ld.aT.parentPath&&(I.ULS.sendTraceTag(508875280,0,15,`AugmentationLoopManager.handleDeleteOperation: parentPath of the operation [${rb.parentPath}] is different from the parentPath of the stored annotation [${ld.aT.parentPath}]`),
ld.aT.parentPath=rb.parentPath),this.qBg(ld),this.Eqa.ZSj(rc.id))}}jok(){this.register(this.RT().NV("ALManagerInternalAnnotations").LV(()=>{}).activateAnnotation({annotationType:Wa.getTypeName(),ls:!1,dO:this.WRj,isInternal:!0}).build());oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1)&&this.Iea("ALManagerInternalAnnotations",{annotationType:"AugLoop_UnitTelemetry_UnitTelemetryAggregatedAnnotation",ls:!0});this.bda&&this.Iea("ALManagerInternalAnnotations",{annotationType:Fa.getTypeName(),
ls:!1,dO:this.yFi,isInternal:!0})}qBg(rb){I.ULS.sendTraceTag(507859417,0,100,`AugmentationLoopManager.raiseAnnotationDeletedEvent: raising deleteAnnotation event (annotation type: ${rb.annotationType})`);const rc=new eb(rb.aT.annotation,rb.aT.r$j,rb.aT.parentPath,3);this.raiseEvent(this.L4d(rb.annotationType),rc,this)}Yne(rb,rc){if(this.$.isEditMode&&this.$.fa.sessionId){I.ULS.sendTraceTag(509371223,0,50,`AugmentationLoopManager.sendObserverRequiredNotification: isObserverRequired: ${this.isObserverRequired}, caller: ${void 0===
rc?"":rc}`);rc=this.$.ma.sa;const ld=rc.$a(1,null);ld.isObserverRequired=rb;kb.h(rc,"ObserverRequiredNotification",ld,null,null,null,null,0)}}submitCustomMessage(rb,rc){rc&&this.DIb(rc,"submitCustomMessage");return this.BE.submitCustomMessage(rb,rc)}E7j(rb,rc){if(this.G4c.DocId!==rb.DocId||this.G4c.Xluid!==rb.Xluid&&this.G4c.Xrevid!==rb.Xrevid)this.G4c=rb,this.raiseEvent("CoauthVersionChanged",{coauthVersion:rb,userContext:rc},this),this.Fqa.D7j(rb)}async Jsf(){if(oa.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.EnableECSToAugLoopServiceOBOFlow",
!1))try{var rb=J.AFrameworkApplication.ea.Qa("AugLoopOAuthResourceUriV2"),rc=ta.TJd(),ld=await this.q4i(await Ma.a.resolve(hb.OAuthManagerWrapperService,{xa:0})),Tb=this.$.ma.sa;ld=ld?ld:"";rc=rc?rc:"";rb=rb?rb:"";const Wc=Tb.$a(1,null);Wc.userPftToken=ld;Wc.endpointURLOverride=rc;Wc.resourceURIOverride=rb;kb.h(Tb,"EnableECSToAugLoopServiceOBOFlow",Wc,null,null,null,null,0)}catch(Wc){I.ULS.sendTraceTag(507295434,0,10,"AugLoopRuntimeProxy.enableECSToAugLoopServiceOBOFlow: Exception thrown")}}async q4i(rb){try{I.ULS.sendTraceTag(507295433,
0,50,"AugLoopRuntimeProxy.getUserPftTokenAsync: called.");const rc=await rb.ey("Core",pa.a.Jra.Application);if(rc.IsSuccess)return I.ULS.sendTraceTag(507295432,0,20,"AugLoopRuntimeProxy.getUserPftTokenAsync: successfully fetched token."),rc.Token;I.ULS.sendTraceTag(507295431,0,15,`AugLoopRuntimeProxy.getUserPftTokenAsync: failed to get token. Error code: ${rc.ErrorCode}, Error message : ${rc.ErrorMessage}`);return null}catch(rc){return I.ULS.sendTraceTag(507295430,0,10,"AugLoopRuntimeProxy.getUserPftTokenAsync: Exception thrown when fetching token"),
null}}x6f(rb,rc){let ld=!1;this.BE.Mtd(Tb=>{Tb.J2||(I.ULS.sendTraceTag(507070178,0,50,`AugmentationLoopManager.isWebSocketDisconnected: caller '${rc}', augloop websocket is disconnected for runtime proxy '${Tb.name}'`),Tb.S9||(ld=!0))},rb);return ld}wYf(rb){return this.b3?this.BE.GWd(rb,rc=>3===rc.tH):3===this.aba.tH}Glj(rb){return this.b3?this.BE.GWd(rb,rc=>3===rc.tH||1===rc.tH):[1,3].includes(this.aba.tH)}Hlj(rb){return this.BE.GWd(rb,rc=>0!==rc.tH)}}Object(N.a)(Kb,"AugmentationLoopManager",Ca.a,
[863,4]);String(G);String(A);window.___1717508060395_closurehack=G;window.___1717508060395_closurehack=A}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaTS.augmentationloop.js.map/af8ccb289bcbe256873f2a9549da1af9/EwaTS.augmentationloop.js.map