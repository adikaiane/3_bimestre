'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[50],{891:function(y,r,a){a.r(r);y={};a.r(y);r=a(5);var c=a(65),b=a(6),f=a(0),k=a(15);class x{constructor(L,J,B,Y,U,O){this.PolicyCookie=this.WebAffinitizedUrl=this.IsSafeLinksEnabled=null;this.PolicyCookieTTL=0;this.WasServiceDown=!1;this.AffinitizedUrl=null;this.IsSafeLinksEnabled=L;this.WebAffinitizedUrl=J;this.PolicyCookie=B;this.PolicyCookieTTL=Y;this.WasServiceDown=U;this.AffinitizedUrl=O}}Object(f.a)(x,"SafeLinksData",
null,[]);class d{constructor(L,J){this.u0c=L;this.stopwatch=J}}Object(f.a)(d,"SafeLinksGetUrlReputationRequestData",null,[]);var h=a(48),n=a(55);class m{constructor(L,J,B,Y){this.C_j=U=>{let O="OnGetUrlReputationSuccessCallback: ",C=10;const X=U.data.state;try{const S=h.b(U.data.responseData).reputationResults[0],ea=S.navigateUrl.length,Oa=X.u0c.length,Ha=S.navigateUrl===X.u0c;S.navigateUrl&&0<S.navigateUrl.length&&(X.u0c=S.navigateUrl);O+=String.format("HttpStatus {0}, verdict {1}, clickedUrlLength = {2} navigateUrlLength {3}, navigateUrlSameAsClickedUrl {4}",
U.data.httpStatus,S.verdict,Oa.toString(),ea.toString(),Ha.toString());C=50}catch(S){O+=String.format("Exception {0}",S.message)}this.jRf(X,O,C)};this.B_j=U=>{let O="OnGetUrlReputationFailureCallback: ";const C=U.data.state;try{O+=String.format("HttpStatus {0}",U.data.httpStatus)}catch(X){O+=String.format("Exception {0}",X.message)}this.jRf(C,O,10)};this.ya=L;this.sg=J;this.Enh=B;m.Xi=Y}rza(L,J,B){try{var Y=null;m.Xi&&(Y=m.Xi.Uc("WebServiceCall","SafeLinksGetUrlReputation"));const U=new d(J,Y);Y=
{};Y.AffinitizedUrl=L;Y.TargetUrl=J;Y.PolicyCookie=B;const O=h.c(Y);this.sg.Wn(this.Enh,2,O,null,!1,2,this.C_j,this.B_j,U,void 0,void 0,3E3,3E3,"36");return!0}catch(U){k.ULS.sendTraceTag(588788033,378,10,U.message)}return!1}jRf(L,J,B){L.stopwatch&&(L.stopwatch.stop(),L.stopwatch=null);k.ULS.sendTraceTag(588788034,378,B,J);n.a.Rg(L.u0c,void 0,"noopener,noreferrer","SafeLinksNav")}}m.Xi=null;Object(f.a)(m,"SafeLinksNavigationHelper",null,[]);var u;(function(L){L[L.Frl=0]="enabledByPolicy";L[L.upf=1]=
"disabledByPolicy";L[L.vrl=2]="disabled_GetPolicyFailure";L[L.wrl=3]="disabled_PendingGetPolicyRequest"})(u||(u={}));Object(f.b)("SafeLinksNavigationState",u);var l=a(103),t=a(202),e=a(615),w=a(284),z=a(239),E=a(877),M=a(39),G=a(189),A=a(366);class N{constructor(L,J,B,Y=!1,U=null,O=null){var C;this.IPa=this.HPa=0;this.tlb=this.jec=!1;this.NBa=null;this.l$a=!0;this.t8a=!1;this.kic=null;this.Q_i=ea=>{let Oa=z.a.hQj,Ha="";try{this.jec=this.tlb=!1;var Za=ea.data.state;const Pa=({stopwatch:Za}=this.mvb(Za)).returnValue,
za=Object.assign({},{durationMs:Pa});l.Health.instance.recordKpiSuccess("SafeLinksGetPolicySuccessfulRequest",za);k.ULS.sendTraceTag(594830614,378,50,"GetSafeLinksDataFromServer_OnSuccessCallback: HttpStatus {0}, data length {1}, Duration {2}",ea.data.httpStatus,ea.data.responseData.length,Pa);if(ea.data.httpStatus!==z.a.nA)Ha="Unexpected httpStatus: "+ea.data.httpStatus.toString();else{Za=null;try{Za=h.b(ea.data.responseData)}catch(wa){Ha="Exception:"+wa.toString()+" deserializing response";return}if(Za){var fa=
Za.IsSafeLinksEnabled;if(void 0===fa||null===fa||0>=fa.length)Ha="Invalid isSafeLinksEnabledString";else{k.ULS.sendTraceTag(594830613,378,50,"Retrieved isSafeLinksEnabledString {0}",fa);var la=N.Tbe(fa);if(void 0===Za.WebAffinitizedUrl||null===Za.WebAffinitizedUrl||0>=Za.WebAffinitizedUrl.length)Ha="Invalid WebAffinitizedUrl";else if(void 0===Za.PolicyCookie||null===Za.PolicyCookie||0>=Za.PolicyCookie.length)Ha="Invalid PolicyCookie";else if(void 0===Za.PolicyCookieTTL||null===Za.PolicyCookieTTL)Ha=
"Invalid PolicyCookieTTL";else{var ba=Za.WebAffinitizedUrl,aa=Za.PolicyCookie,oa=Za.AffinitizedUrl,Na=new Date;Na.setMinutes(Na.getMinutes()+(5<Za.PolicyCookieTTL?Za.PolicyCookieTTL-5:0));var Ia=Na.getTime(),Sa=new x(fa,ba,aa,Ia,!1,oa);this.bQg(Sa);Oa=ea.data.httpStatus;this.NBa&&(la?(this.V4g(this.NBa),this.IPa=this.HPa=0):(k.ULS.sendTraceTag(26019602,378,50,"SafeLinks is disabled by admin; Navigating without SafeLinks"),l.Health.instance.recordKpiFailure("SafeLinksNavigations","disabledByPolicy",
!0,!0,null),n.a.YX(this.NBa)),this.NBa=null)}}}else Ha="Error when serializing response into SafeLinksData. SafeLinksData is null."}}catch(Pa){Ha="GetSafeLinksDataFromServer_OnSuccessCallback: Exception:  "+Pa.toString()}finally{Oa!==z.a.nA&&this.iRf(Oa,Ha)}};this.P_i=ea=>{this.jec=!1;let Oa=500,Ha="";try{let Za=ea.data.state;const fa=({stopwatch:Za}=this.mvb(Za)).returnValue,la=Object.assign({},{durationMs:fa});Oa=ea.data.httpStatus;l.Health.instance.recordKpiFailure("SafeLinksGetPolicyFailedRequest",
"HttpStatusCode_"+Oa.toString(),!1,!0,la);Ha="Request Failed, Status="+E.a[ea.data.status]+" Duration: "+fa}catch(Za){Ha="GetSafeLinksDataFromServer_OnFailureCallback Exception: "+Za.toString()}finally{this.iRf(Oa,Ha)}};k.ULS.sendTraceTag(26019598,378,100,"Initializing SafeLinksManager.");this.ya=L;this.sg=J;this.jy=B;N.Xi=O;this.Xwh=Y?this.ya.Qa("SafeLinksHandlerWebServiceBase"):this.ya.Qa("WebServiceBase");this.Gwh=this.ya.Qa("SafeLinksHashedUserId");this.Ykl=this.ya.Qa("SafeLinksWorkloadIdHeaderValue");
this.Xfc=this.ya.Rd("SafeLinksMaxGetPolicyBootRetries",2);this.Yfc=this.ya.Rd("SafeLinksMaxGetPolicyOnLinkClickRetries",1);this.Tec=this.isSafeLinksEnabledForUser();this.Sec=this.mwj();N.T_e=this.ya.Qa("UserPrincipalName")||"";N.RZe=this.ya.Qa("TenantId")||"";k.ULS.sendTraceTag(26019599,378,50,"SafeLinksManager _isEnabledForUser={0}, _isEnabledForBrowser={1}",this.Tec,this.Sec);if(this.Tec&&this.Sec){J=(L=this.jGa())?L.IsSafeLinksEnabled.toLowerCase():"";B=this.tYd();k.ULS.sendTraceTag(36231312,378,
50,"Cached values for IsSafeLinksEnabled: {0}, IsPolicyCookieExpired: {1}.",J,B);var X=!L||"unknown"===J||L.WasServiceDown||B,S=t.a.ip();S&&(S.set("shouldGetSafeLinksDataFromServer",X.toString()),S.set("isSafeLinksEnabledCacheValue",J.toString()));this.t8a=null===(C=b.AFrameworkApplication.ea)||void 0===C?void 0:C.getBooleanFeatureGate("Microsoft.Office.SharedOnline.WACAADTokenForSafeLinksIsEnabled",!1);U?(this.l$a=!1,U.execute(ea=>{ea.isFeatureEnabled("MsoUrlreputation",!0).then(Oa=>{this.l$a=Oa;
S.set("isUserLicensedForSafeLinks",this.l$a.toString());l.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",A.b.FailureBased,"jpittsdirects",S);this.l$a&&X&&(this.t8a?this.bBc(!0):this.AQb(!0));return null})})):(l.Health.instance.recordKpiUsage("SafeLinksGetPolicy1",A.b.FailureBased,"jpittsdirects",S),X&&(this.t8a?this.bBc(!0):this.AQb(!0)))}}get appName(){return this.jy}get y4c(){return this.Xwh}get userId(){return this.Gwh}get aPf(){try{if(""===N.Nad){const L={};L["X-AppName"]=this.appName;L["X-AppVersion"]=
b.AFrameworkApplication.buildVersion;L.OS=this.ya.Qa("PlatformNameAndVersion")||"";const J=JSON.stringify(L);N.Nad=window.self.btoa(J)}}catch(L){k.ULS.sendTraceTag(508909765,378,10,"GetUrlReputationAdditionalProperties Error: {0}",L.message)}return N.Nad}get ZXi(){const L=this.y4c?this.y4c+"/":"",J=new w.QueryStringBuilder("SafeLinksHandler.ashx");J.uj("app",this.appName);this.ya.ka("SafeLinksUseDebugHeader")&&J.uj("action","debug");this.t8a&&J.uj("s2se03pft","1");this.ya.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",
!1)&&J.uj("s2satpop","1");this.ya.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&J.uj("s2se03","1");return String.format("{0}{1}&{2}",L,J.toString(),b.AFrameworkApplication.Uh)}get d4i(){const L=this.y4c?this.y4c+"/":"",J=new w.QueryStringBuilder("SafeLinksHandler.ashx");J.uj("app",this.appName);this.ya.ka("SafeLinksUseDebugHeader")&&J.uj("action","debug");this.ya.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAATPOP",!1)&&J.uj("s2satpop",
"1");this.ya.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthAAT",!1)&&J.uj("s2saat","1");this.ya.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksS2SAuthUseE03App",!1)&&J.uj("s2se03","1");this.ya.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksParamUpdates",!1)&&J.uj("sladpar",this.aPf);J.uj("slrt","GetUrlReputation");return String.format("{0}{1}&{2}",L,J.toString(),b.AFrameworkApplication.Uh)}get bPj(){N.Nid||(N.Nid=new m(this.ya,this.sg,this.d4i,
N.Xi));return N.Nid}rza(L){if(!L)return k.ULS.sendTraceTag(593367827,378,10,"SafeLinksManager.TryNavigate: Null/Empty targetUrl"),!1;var J=this.Trj(L);k.ULS.sendTraceTag(594830615,378,50,"SafeLinksManager.TryNavigate: isSupportedHyperLinkType={0},_isEnabledForUser={1},_isEnabledForBrowser={2},_isUserLicensedForSafeLinks={3}",J,this.Tec,this.Sec,this.l$a);if(!(J&&this.Tec&&this.Sec&&this.l$a))return!1;J=0;const B=({state:J}=this.GTk()).returnValue;k.ULS.sendTraceTag(595079385,378,50,"ShouldTryUsingSafeLinksService returned NavigationState={0}",
u[J]);const Y=t.a.ip();Y&&Y.set("SafeLinksNavigationState",u[J]);l.Health.instance.recordKpiUsage("SafeLinksNavigations",A.b.FailureBased,"jpittsdirects",Y);if(!B)return 2!==J&&3!==J||l.Health.instance.recordKpiFailure("SafeLinksNavigations",u[J],!1,!0,null),!1;k.ULS.sendTraceTag(26019601,378,50,"Using safelinks to navigate hyperlink");if(this.STk())return this.tYd()?!1:this.bPj.rza(this.gJi(),L,this.iMf());if(!this.tYd())return this.V4g(L),!0;this.NBa=L;k.ULS.sendTraceTag(24462627,378,50,"Refreshing the cache as policy cookie expired.");
this.tlb=!1;this.t8a?this.bBc():this.AQb();return!0}Trj(L){L=L.toLowerCase();const J=this.ya.Yk("SafeLinksUnsupportedProtocols");if(J)for(let B=0;B<J.length;B++)if(L.startsWith(J[B]))return!1;return!0}bBc(L=!1){this.sg.p0b(()=>{this.AQb(L)})}AQb(L=!1){var J;(null===(J=b.AFrameworkApplication.ea)||void 0===J?0:J.getBooleanFeatureGate("Microsoft.Office.WordOnline.SkipGetSafeLinksRequestIfAppShuttingDown",!1))&&b.AFrameworkApplication.Sf||((J=t.a.ip())&&J.set("isOnBootRequest",L.toString()),l.Health.instance.recordKpiUsage("SafeLinksGetPolicySuccessfulRequest",
A.b.SuccessBased,"jpittsdirects",J),l.Health.instance.recordKpiUsage("SafeLinksGetPolicyFailedRequest",A.b.FailureBased,"jpittsdirects",J),J=this.bKb("SafeLinksGetPolicy"),this.sg.Wn(this.ZXi,1,null,null,!0,2,this.Q_i,this.P_i,J,void 0,void 0,void 0,void 0,"23"),this.tlb=L,this.jec=!0,L?this.HPa++:this.IPa++)}iRf(L,J=""){try{if(k.ULS.sendTraceTag(594830612,378,10,"HandleGetPolicyRequestError: HttpStatus {0}, Error {1}",L,J),this.HPa<this.Xfc&&this.IPa<this.Yfc)this.t8a?this.bBc(this.tlb):this.AQb(this.tlb);
else{this.tlb=!1;k.ULS.sendTraceTag(24462656,378,10,"Exhausted all retries for SafeLinks GetPolicy call. OnBootRetries: {0}, OnClickRetries: {1}, HttpStatus: {2}, Error: {3}",this.HPa,this.IPa,L,J);J=null;const B=t.a.ip();B&&(B.set("HttpStatus",L.toString()),J=Object.assign({},{extendedProperties:B}));l.Health.instance.recordKpiFailure("SafeLinksGetPolicy1","GetPolicyRequestError",!1,!0,J);const Y=new x("false","","",0,!0,"");this.bQg(Y);this.NBa&&(k.ULS.sendTraceTag(26019603,378,50,"Error occurred during at-click GetPolicy call, NavigationState = {0}",
"disabled_GetPolicyFailure"),l.Health.instance.recordKpiFailure("SafeLinksNavigations","disabled_GetPolicyFailure",!1,!0,null),n.a.YX(this.NBa),this.NBa=null)}}catch(B){k.ULS.sendTraceTag(594830611,378,10,"HandleGetPolicyRequestError: Exception {0}",B.toString())}}V4g(L){const J=this.iMf(),B=this.b5i(),Y={};Y.Url=L;Y.SafeLinksCookie=J;Y.CorrelationId=G.a.create().toString();Y.WorkloadId=this.Ykl;Y.UserAgentInfo=M.a.s6+"|"+this.appName;this.ya.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksParamUpdates",
!1)&&(Y.User=N.T_e,Y.TenantId=N.RZe,Y.AdditionalProperties=this.aPf);k.ULS.sendTraceTag(23900187,378,50,"Validating hyperlink with request correlation: {0}",Y.CorrelationId);n.a.v1b(n.a.h_(4),B,Y)}isSafeLinksEnabledForUser(){const L=this.ya.Qa("IsSafeLinksEnabledForUser");return L?N.Tbe(L):!1}mwj(){const L=this.ya.Yk("SafeLinksDisabledBrowsers");if(M.a.yY){if(this.ya.Dj("SafeLinksForTeamsIsEnabled")&&this.ya.ka("SafeLinksForTeamsIsEnabled"))return!0;if(Array.contains(L,"Electron"))return!1}else if(Array.contains(L,
M.a.s6))return!1;return"officecomhwa"===(this.ya.Qa(b.AFrameworkApplication.fW)||"").toLowerCase()?!1:!0}STk(){return-1!==window.location.href.indexOf("&wd_slnh=1")||this.ya.getBooleanFeatureGate("Microsoft.Office.SharedOnline.SafeLinksUseNavigationHelperForMobile",!1)&&M.a.AY?!0:M.a.yY||M.a.XIc}GTk(){let L;L=0;const J=this.jGa(),B=J?J.IsSafeLinksEnabled:"";if(""!==B)return J.WasServiceDown?(k.ULS.sendTraceTag(51663971,378,50,"Failed to retrieve policy data"),{returnValue:!1,state:2}):"false"===B.toLowerCase()?
(k.ULS.sendTraceTag(51664E3,378,50,"SafeLinks disabled for the user"),{returnValue:!1,state:1}):{returnValue:N.Tbe(B),state:L};if(this.jec)return L=3,k.ULS.sendTraceTag(595079384,378,50,"Currently getting SafeLinks policy"),{returnValue:!1,state:L};if(this.HPa>=this.Xfc||this.IPa>=this.Yfc)return L=2,k.ULS.sendTraceTag(51664001,378,50,"Exhausted all retries- Failure in GetPolicy for SafeLinks ({0}/{1} boot, {2}/{3} onClick)",this.HPa,this.Xfc,this.IPa,this.Yfc),{returnValue:!1,state:L};k.ULS.sendTraceTag(23900182,
378,10,"Inconsistent SafeLinks state: SafeLinks cache data is null with no on boot request pending, and {0} retries left over. Perhaps LocalStorage is inaccessable.",this.Xfc+this.Yfc-(this.HPa+this.IPa));return{returnValue:!0,state:L}}iMf(){const L=this.jGa();return L?L.PolicyCookie:""}b5i(){const L=this.jGa();return L?L.WebAffinitizedUrl:""}gJi(){const L=this.jGa();return L?L.AffinitizedUrl:""}pQi(){const L=new Date;try{const J=this.jGa();L.setTime(J?J.PolicyCookieTTL:0)}catch(J){k.ULS.sendTraceTag(24462658,
378,10,"Exception occured while fetching expiration time from cache: {0}",J)}return L}tYd(){const L=this.pQi();return!!L&&L.getTime()<Date.now()}jGa(){if(!this.kic){const L=e.a.instance.getItem(this.userId);if(!L||""===L)return null;this.kic=JSON.parse(L)}return this.kic}bQg(L){if(void 0===L||null===L)throw Error.argumentNull("safeLinksData");if(void 0===L.IsSafeLinksEnabled||null===L.IsSafeLinksEnabled||0>=L.IsSafeLinksEnabled.length)throw Error.argumentNull("safeLinksData.IsSafeLinksEnabled");this.kic=
L;L.WasServiceDown||this.hll(L)}hll(L){L=JSON.stringify(L);e.a.instance.setItem(this.userId,L)}bKb(L){return void 0!==N.Xi&&null!==N.Xi?N.Xi.Uc("WebServiceCall",L):null}mvb(L){if(void 0!==L&&null!==L){const J=L.Kc;L.stop();return{returnValue:J,stopwatch:null}}return{returnValue:null,stopwatch:L}}static Tbe(L){return"false"!==L.toLowerCase()?!0:!1}}N.Xi=null;N.Nid=null;N.RZe="";N.T_e="";N.Nad="";Object(f.a)(N,"SafeLinksManager",null,[283]);const K=L=>{switch(L){case 3:return"Word";case 2:return"PowerPoint";
case 1:return"Excel";default:return"Unknown"}},I=L=>{switch(L){case 1:return"Edit";case 2:return"View";case 3:return"InstantView";default:return"Unknown"}};Object(c.b)(r.SafeLinksService,{we:"singleton"})(()=>new N(b.AFrameworkApplication.ea,b.AFrameworkApplication.od,String.format("{0}-{1}",K(b.AFrameworkApplication.ua.Ab.gi),I(b.AFrameworkApplication.ua.Ab.rwa))));String(y);window.___1717508060513_closurehack=y}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaTS.safelinks.js.map/e5173ff9138c3222c80915bd93e36557/EwaTS.safelinks.js.map